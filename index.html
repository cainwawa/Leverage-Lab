<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢è²¸æŠ•è³‡å£“åŠ›æ¸¬è©¦æ¨¡æ“¬å™¨ v2.17 - é¢¨éšªè¨»é‡‹å„ªåŒ–ç‰ˆ</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ Babel (è®“ç€è¦½å™¨èƒ½è®€æ‡‚ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. è¨­å®š Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0?external=react"
        }
    }
    </script>

    <style>
        body { font-family: "Noto Sans TC", sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 4. æ‡‰ç”¨ç¨‹å¼ä¸»é‚è¼¯ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, memo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, Area, ComposedChart, Legend, BarChart, Bar, Cell, ReferenceDot, Label } from 'recharts';
        import { AlertTriangle, TrendingUp, DollarSign, Activity, Info, RefreshCw, Wallet, Settings, Landmark, Plus, Minus, CheckSquare, ArrowRight, Eye, Layers, AlertOctagon, TrendingDown, Cpu, ThumbsUp, ThumbsDown, HelpCircle, BarChart2, ShieldAlert, Scale, Zap, BookOpen, Search, X, Skull, Hash, ShieldCheck, Target, Flag, Clock, Timer, Sigma, HeartPulse, Anchor, Loader2, Bomb, RotateCcw, Siren, Lock, ExternalLink, CalendarClock } from 'lucide-react';

        // --- æ•¸å­¸æ ¸å¿ƒå‡½å¼åº« ---

        const randn_bm = () => {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        };

        const calculateStdDev = (values) => {
            if (!values || values.length === 0) return 0;
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
            return Math.sqrt(variance);
        };

        const calculateIRR = (initial, monthly, growthRate, years, finalValue) => {
            if (finalValue <= 0) return -100;
            let low = -0.99, high = 5.0; 
            const totalSteps = years * 12;
            for (let i = 0; i < 30; i++) {
                const mid = (low + high) / 2;
                const monthlyRate = Math.pow(1 + mid, 1/12) - 1; 
                let npv = -initial;
                let discountFactor = 1 + monthlyRate;
                for (let t = 0; t < totalSteps; t++) {
                    const currentInjection = monthly * Math.pow(1 + growthRate / 100, t / 12);
                    npv -= currentInjection / discountFactor; 
                    discountFactor *= (1 + monthlyRate);
                }
                npv += finalValue / Math.pow(1 + mid, years);
                if (npv > 0) low = mid; else high = mid;
            }
            return ((low + high) / 2) * 100;
        };

        const calculateLoanSchedule = (loan, totalMonths) => {
            const { amount, years, rate, grace } = loan;
            const schedule = new Array(totalMonths).fill({ payment: 0, principal: 0, interest: 0, balance: 0 });
            if (amount <= 0) return schedule;
            const monthlyRate = rate / 100 / 12;
            const loanMonths = years * 12;
            const graceMonths = grace * 12;
            let currentBalance = amount;
            for (let t = 1; t <= totalMonths; t++) {
                if (t > loanMonths) { schedule[t-1] = { payment: 0, principal: 0, interest: 0, balance: 0 }; continue; }
                let payment = 0, interest = currentBalance * monthlyRate, principal = 0;
                if (t <= graceMonths) { payment = interest; principal = 0; }
                else {
                    const n = loanMonths - graceMonths; 
                    if (monthlyRate === 0) { principal = amount / n; payment = principal; interest = 0; }
                    else { const pmt = amount * (monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1); payment = pmt; principal = payment - interest; }
                }
                if (currentBalance - principal < 1e-4) { principal = currentBalance; payment = principal + interest; currentBalance = 0; }
                else { currentBalance -= principal; }
                schedule[t-1] = { payment, principal, interest, balance: currentBalance };
            }
            return schedule;
        };

        // --- UI Components ---

        const InputSlider = memo(({ value, setter, min, max, step, suffix, width = "flex-1", enableInput = false, disabled = false }) => {
            const [inputValue, setInputValue] = useState(value);
            const [isFocused, setIsFocused] = useState(false);
            useEffect(() => { if (!isFocused) setInputValue(value); }, [value, isFocused]);
            const handleInputChange = (e) => setInputValue(e.target.value);
            const commitValue = () => { let num = parseFloat(inputValue); if (isNaN(num)) num = value; setter(num); setInputValue(num); };
            const handleBlur = () => { setIsFocused(false); commitValue(); };
            const handleKeyDown = (e) => { if (e.key === 'Enter') { commitValue(); e.target.blur(); }};
            const handleFocus = () => setIsFocused(true);
            return (
                <div className={`flex items-center gap-2 mt-1 w-full ${disabled ? 'opacity-50 pointer-events-none' : ''}`}>
                    <input
                        type="range" min={min} max={max} step={step} value={value}
                        onChange={(e) => setter(Number(e.target.value))}
                        disabled={disabled}
                        className={`${width} h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 min-w-0`}
                    />
                    {enableInput ? (
                        <div className={`flex items-center w-14 shrink-0 bg-white border rounded px-1 transition-all ${isFocused ? 'ring-2 ring-indigo-100 border-indigo-400' : 'border-slate-300 hover:border-indigo-300'}`}>
                            <input 
                                type="number" step="any" value={inputValue} onChange={handleInputChange} onBlur={handleBlur} onKeyDown={handleKeyDown} onFocus={handleFocus}
                                disabled={disabled}
                                className="w-full text-xs font-mono text-right bg-transparent outline-none p-0.5 appearance-none m-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                placeholder="0"
                            />
                        </div>
                    ) : (
                        <span className="text-xs font-mono w-12 text-right text-slate-600 shrink-0 select-none">{value}{suffix}</span>
                    )}
                </div>
            );
        });

        const LoanCard = memo(({ loan, onUpdate }) => {
            const isInterestOnly = loan.grace >= loan.years && loan.years > 0;
            const monthlyRate = loan.rate / 100 / 12;
            const gracePayment = (loan.amount * 10000 * monthlyRate);
            let amortizationPayment = 0;
            if (loan.amount > 0 && loan.years > loan.grace) {
                const n = (loan.years - loan.grace) * 12; 
                if (monthlyRate === 0) amortizationPayment = (loan.amount * 10000) / n;
                else amortizationPayment = (loan.amount * 10000) * (monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1);
            }
            const handleInterestOnlyToggle = (e) => {
                onUpdate(loan.id, 'grace', e.target.checked ? loan.years : 0);
            };
            const handleMarginToggle = (e) => {
                const isChecked = e.target.checked;
                onUpdate(loan.id, 'enableMargin', isChecked);
                if (isChecked) {
                    // Logic Update: Enable Margin automatically enables Interest Only (Grace period = Loan years)
                    onUpdate(loan.id, 'grace', loan.years);
                    // Do not mutually exclude repayAtMaturity
                }
            };
            const handleRepayAtMaturityToggle = (e) => {
                onUpdate(loan.id, 'repayAtMaturity', e.target.checked);
            };

            // Dynamic border styling based on risk features enabled
            const borderClass = loan.enableMargin || loan.repayAtMaturity 
                ? 'border-red-100 ring-1 ring-red-50' 
                : 'border-slate-100';

            return (
            <div className={`bg-white p-4 rounded-xl border mb-3 shadow-sm relative overflow-hidden transition-all hover:shadow-md ${borderClass}`}>
                <div className="flex justify-between items-start mb-3 border-b border-slate-50 pb-2">
                    <div>
                        <span className="font-bold text-sm text-slate-700 block mb-1">{loan.name}</span>
                        <div className="flex flex-col gap-1">
                        {loan.amount > 0 ? (
                            isInterestOnly ? (
                                <div className="flex flex-col gap-1">
                                    <span className="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded-full font-mono font-medium">
                                        ç¹³æ¯: {Math.round(gracePayment).toLocaleString()} /æœˆ
                                    </span>
                                    {loan.repayAtMaturity && (
                                        <span className="text-[10px] bg-red-50 text-red-700 px-2 py-0.5 rounded-full font-mono font-medium flex items-center gap-1">
                                            <CalendarClock size={10} />
                                            ç¬¬{loan.years}å¹´éœ€é‚„æœ¬: {loan.amount}è¬
                                        </span>
                                    )}
                                </div>
                            ) : (
                                loan.grace > 0 ? (
                                    <div className="flex flex-col gap-1">
                                        <span className="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded-full font-mono font-medium flex justify-between w-full gap-2">
                                            <span>å‰{loan.grace}å¹´ç¹³æ¯:</span> 
                                            <span>{Math.round(gracePayment).toLocaleString()}</span>
                                        </span>
                                        <span className="text-[10px] bg-amber-50 text-amber-700 px-2 py-0.5 rounded-full font-mono font-medium flex justify-between w-full gap-2">
                                            <span>å¾Œ{loan.years - loan.grace}å¹´æ”¤é‚„:</span>
                                            <span>{Math.round(amortizationPayment).toLocaleString()}</span>
                                        </span>
                                    </div>
                                ) : (
                                    <span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-600 font-mono font-medium">
                                        æœ¬æ¯: {Math.round(amortizationPayment).toLocaleString()} /æœˆ
                                    </span>
                                )
                            )
                        ) : <span className="text-[10px] text-slate-400">æœªè¨­å®šé‡‘é¡</span>}
                        </div>
                    </div>
                    <label className={`flex items-center gap-1.5 cursor-pointer select-none shrink-0 ml-2 mt-1 ${loan.enableMargin ? 'opacity-50 cursor-not-allowed' : ''}`}>
                        <input type="checkbox" checked={isInterestOnly} onChange={handleInterestOnlyToggle} disabled={loan.enableMargin} className="w-3.5 h-3.5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300 disabled:opacity-50" />
                        <span className="text-xs text-slate-500 font-medium">{loan.enableMargin ? <span className="flex items-center gap-1"><Lock size={10}/>é–å®š</span> : 'åªé‚„æ¯'}</span>
                    </label>
                </div>
                <div className="space-y-4">
                    <div>
                        <label className="text-[11px] font-bold text-slate-500 block mb-1">é‡‘é¡ (è¬)</label>
                        <InputSlider value={loan.amount} setter={(v) => onUpdate(loan.id, 'amount', v)} min={0} max={5000} step={10} suffix="" enableInput={true}/>
                    </div>
                    <div>
                        <label className="text-[11px] font-bold text-slate-500 block mb-1">åˆ©ç‡ (%)</label>
                        <InputSlider value={loan.rate} setter={(v) => onUpdate(loan.id, 'rate', v)} min={1.0} max={10.0} step={0.1} suffix="" enableInput={true}/>
                    </div>
                    <div>
                        <label className="text-[11px] font-bold text-slate-500 block mb-1">å¹´é™ (å¹´)</label>
                        <InputSlider value={loan.years} setter={(v) => onUpdate(loan.id, 'years', v)} min={1} max={30} step={1} suffix="" enableInput={true}/>
                    </div>
                    
                    {/* Grace Period - Has opacity when disabled */}
                    <div className={isInterestOnly ? "opacity-40 transition-opacity" : "transition-opacity"}>
                        <label className="text-[11px] font-bold text-slate-500 block mb-1 flex justify-between">
                            <span>å¯¬é™æœŸ (å¹´)</span>
                            {loan.enableMargin && <span className="text-[9px] text-red-400 flex items-center gap-1"><Lock size={8}/> èè³‡æ¨¡å¼å¼·åˆ¶å…¨å¯¬é™</span>}
                        </label>
                        <InputSlider value={loan.grace} setter={(v) => onUpdate(loan.id, 'grace', v)} min={0} max={loan.years} step={1} suffix="" enableInput={true} disabled={loan.enableMargin}/>
                    </div>

                    {/* Balloon Payment Checkbox - MOVED OUTSIDE of opacity div */}
                    {isInterestOnly && (
                        <div className="flex items-center gap-2 animate-in slide-in-from-top-1 -mt-2">
                            <label className="flex items-center gap-1.5 cursor-pointer select-none">
                                <input type="checkbox" checked={loan.repayAtMaturity || false} onChange={handleRepayAtMaturityToggle} className="w-3.5 h-3.5 rounded text-red-600 focus:ring-red-500 border-slate-300" />
                                <span className={`text-[11px] font-bold ${loan.repayAtMaturity ? 'text-red-600' : 'text-slate-400'}`}>åˆ°æœŸå…¨é‚„ï¼ˆæ¨¡æ“¬ä¸èƒ½çºŒç´„ï¼‰</span>
                            </label>
                        </div>
                    )}
                    
                    {/* Margin Maintenance Section - REMOVED border-t */}
                    <div className="pt-2">
                        <div className="flex justify-between items-center mb-1">
                            <label className="flex items-center gap-1.5 cursor-pointer select-none">
                                <input type="checkbox" checked={loan.enableMargin || false} onChange={handleMarginToggle} className="w-3.5 h-3.5 rounded text-red-600 focus:ring-red-500 border-slate-300" />
                                <span className={`text-[11px] font-bold ${loan.enableMargin ? 'text-red-600' : 'text-slate-400'}`}>å•Ÿç”¨ç¶­æŒç‡é™åˆ¶ (çˆ†å€‰)</span>
                            </label>
                        </div>
                        {loan.enableMargin && (
                            <div className="animate-in slide-in-from-top-1 duration-200">
                                <label className="text-[10px] text-red-400 block mb-1 flex items-center gap-1"><Siren size={10}/> æœ€ä½ç¶­æŒç‡ (%)</label>
                                <InputSlider value={loan.maintenanceMargin || 130} setter={(v) => onUpdate(loan.id, 'maintenanceMargin', v)} min={100} max={200} step={5} suffix="%" enableInput={true}/>
                                <p className="text-[10px] text-slate-400 mt-1 leading-tight">
                                    è‹¥ (è³‡ç”¢ / èè³‡è² å‚µ) ä½æ–¼ {(loan.maintenanceMargin || 130)}% å°‡å¼·åˆ¶æ¸…ç®—ã€‚
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
            );
        });

        // è‡ªå®šç¾© Tooltip
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                const isSurvivalMode = payload.some(p => p.name === 'survivalLev');

                return (
                    <div className="bg-white p-3 border border-slate-100 shadow-xl rounded-xl text-xs z-50">
                        <p className="font-bold text-slate-700 mb-2 border-b border-slate-100 pb-1">ç¬¬ {label} å¹´</p>
                        <div className="space-y-1">
                            {payload.map((entry, index) => {
                                if (entry.name.includes('bg') || entry.name.includes('Range')) return null;
                                
                                let displayName = entry.name;
                                let valueColor = entry.color;
                                let value = entry.value;
                                let pl = 0;
                                let isLeverageMode = entry.name.includes('LevRatio') || entry.name.includes('BaseRatio'); 
                                let isTargetMode = entry.name.includes('probLev') || entry.name.includes('probBase');

                                if (entry.name === 'survivalLev') { displayName = 'å­˜æ´»ç‡ (æœ‰è²¸æ¬¾)'; valueColor = '#dc2626'; value = entry.value.toFixed(1) + '%'; }
                                else if (entry.name === 'survivalBase') { displayName = 'å­˜æ´»ç‡ (ç„¡è²¸æ¬¾)'; valueColor = '#0ea5e9'; value = entry.value.toFixed(1) + '%'; }
                                else if (entry.name === 'p50Lev') { displayName = 'æœ‰è²¸æ¬¾ (P50)'; valueColor = '#ea580c'; }
                                else if (entry.name === 'p50Base') { displayName = 'ç„¡è²¸æ¬¾ (P50)'; valueColor = '#0ea5e9'; }
                                else if (entry.name === 'focusLev') { displayName = 'æœ‰è²¸æ¬¾ (è©²å®‡å®™)'; valueColor = '#ea580c'; }
                                else if (entry.name === 'focusBase') { displayName = 'ç„¡è²¸æ¬¾ (è©²å®‡å®™)'; valueColor = '#0ea5e9'; }
                                else if (entry.name === 'principal') { displayName = 'ç´¯ç©è‡ªæœ‰æŠ•å…¥'; valueColor = '#f59e0b'; }
                                else if (entry.name === 'probLev') { displayName = 'é”æ¨™æ©Ÿç‡ (æœ‰è²¸æ¬¾)'; valueColor = '#ea580c'; }
                                else if (entry.name === 'probBase') { displayName = 'é”æ¨™æ©Ÿç‡ (ç„¡è²¸æ¬¾)'; valueColor = '#0ea5e9'; }

                                if (value < 50 && value > -50 && entry.dataKey !== 'principal' && !isTargetMode && !isSurvivalMode && typeof value === 'number') { 
                                     if (entry.name === 'p50Lev') { displayName = 'æ§“æ¡¿å€æ•¸ (P50)'; }
                                     if (entry.name === 'p50Base') { displayName = 'åŸºæº–æ§“æ¡¿'; }
                                     if (entry.name === 'focusLev') { displayName = 'è©²å®‡å®™æ§“æ¡¿'; }
                                }

                                const principalEntry = payload.find(p => p.dataKey === 'principal');
                                const principal = principalEntry ? principalEntry.value : 0;
                                if (entry.name !== 'principal' && !isTargetMode && !isLeverageMode && !isSurvivalMode && typeof value === 'number') {
                                    pl = value - principal;
                                }

                                let displayValue;
                                // Handle Ruin explicitly in Tooltip
                                if ((entry.dataKey === 'focusLev' || entry.dataKey === 'p50Lev') && value === 0 && !isTargetMode && !isSurvivalMode && !isLeverageMode) {
                                    displayValue = "ğŸ’€ å·²æ­¸é›¶ç ´ç”¢";
                                    valueColor = "#dc2626";
                                } else if (isSurvivalMode || isTargetMode) {
                                    displayValue = typeof value === 'string' ? value : (typeof value === 'number' ? `${value.toFixed(1)}%` : value);
                                } else if (entry.name === 'principal') {
                                    displayValue = `${new Intl.NumberFormat('zh-TW').format(Math.round(value))} è¬`;
                                } else if (typeof value === 'number' && (value > 50 || value < -50)) {
                                    displayValue = `${new Intl.NumberFormat('zh-TW').format(Math.round(value))} è¬`;
                                } else {
                                    displayValue = typeof value === 'number' ? `${value.toFixed(2)}x` : value;
                                }

                                return (
                                    <div key={index} className="flex flex-col mb-2">
                                        <div className="flex items-center justify-between gap-4">
                                            <div className="flex items-center gap-2">
                                                <span className="w-2 h-2 rounded-full" style={{ backgroundColor: entry.color }}></span>
                                                <span className="font-medium text-slate-600">{displayName}</span>
                                            </div>
                                            <span className="font-mono font-bold" style={{ color: valueColor }}>
                                                {displayValue}
                                            </span>
                                        </div>
                                        {entry.name !== 'principal' && !isTargetMode && !isSurvivalMode && typeof value === 'number' && (value > 50 || value < -50) && (
                                            <div className="flex justify-end gap-2 text-[10px]">
                                                <span className="text-slate-400">æç›Š:</span>
                                                <span className={`font-mono font-bold ${pl >= 0 ? 'text-emerald-600' : 'text-red-500'}`}>
                                                    {pl > 0 ? '+' : ''}{new Intl.NumberFormat('zh-TW').format(Math.round(pl))} è¬
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }
            return null;
        };

        const CustomLegend = ({ payload, visibleSeries, onToggle }) => {
            if (!payload) return null;
            return (
                <div className="flex flex-wrap justify-center gap-4 mb-6 font-sans">
                    {payload.map((entry, index) => {
                        const key = entry.id;
                        const isVisible = visibleSeries ? visibleSeries[key] : true;
                        return (
                            <div 
                                key={index} 
                                onClick={() => onToggle && onToggle(key)}
                                className={`
                                    flex items-center gap-2 px-3 py-1.5 rounded-full shadow-sm border transition-all cursor-pointer select-none
                                    ${isVisible ? 'bg-white border-slate-100 hover:scale-105' : 'bg-slate-100 border-slate-200 opacity-50 grayscale'}
                                `}
                            >
                                <div 
                                    className="w-3 h-3 rounded-full ring-2 ring-white drop-shadow-sm shrink-0 transition-colors" 
                                    style={{ backgroundColor: isVisible ? entry.color : '#94a3b8' }}
                                ></div>
                                <span className={`text-sm font-bold leading-none pt-[1px] ${isVisible ? 'text-slate-700' : 'text-slate-500'}`}>
                                    {entry.value}
                                </span>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const App = () => {
            const [initialCapital, setInitialCapital] = useState(300); 
            const [cagr, setCagr] = useState(8);                      
            const [volatility, setVolatility] = useState(20);        
            const [years, setYears] = useState(10);                   
            const [simulationCount, setSimulationCount] = useState(500); 
            const [monthlySavings, setMonthlySavings] = useState(5); 
            const [savingsGrowthRate, setSavingsGrowthRate] = useState(3); 
            const [targetAmount, setTargetAmount] = useState(1000); 

            const [loans, setLoans] = useState([
                { id: 1, name: "è²¸æ¬¾ A", amount: 200, years: 30, rate: 2.2, grace: 5, active: true, maintenanceMargin: 130, enableMargin: false, repayAtMaturity: false },
                { id: 2, name: "è²¸æ¬¾ B", amount: 0, years: 7, rate: 3.5, grace: 0, active: true, maintenanceMargin: 130, enableMargin: false, repayAtMaturity: false },
                { id: 3, name: "è²¸æ¬¾ C", amount: 0, years: 20, rate: 2.5, grace: 0, active: true, maintenanceMargin: 130, enableMargin: false, repayAtMaturity: false },
            ]);

            const [stressTestActive, setStressTestActive] = useState(false);
            const [backupState, setBackupState] = useState(null);

            const triggerStressTest = () => {
                // Snapshot current state
                setBackupState({
                    initialCapital,
                    cagr,
                    volatility,
                    monthlySavings,
                    savingsGrowthRate,
                    targetAmount,
                    loans: JSON.parse(JSON.stringify(loans)) // Deep copy
                });

                // Apply Stress params
                setInitialCapital(100);
                setCagr(0); // Flat market
                setVolatility(40); // High Vol
                setMonthlySavings(0); // No backup
                setLoans(prev => prev.map(l => l.id === 1 ? { ...l, amount: 400 } : l)); // Force high leverage on Loan A
                
                setStressTestActive(true);
            };

            const restoreSettings = () => {
                if (!backupState) return;
                setInitialCapital(backupState.initialCapital);
                setCagr(backupState.cagr);
                setVolatility(backupState.volatility);
                setMonthlySavings(backupState.monthlySavings);
                setSavingsGrowthRate(backupState.savingsGrowthRate);
                setTargetAmount(backupState.targetAmount);
                setLoans(backupState.loans);
                setStressTestActive(false);
                setBackupState(null);
            };

            const updateLoan = useCallback((id, field, value) => {
                setLoans(prev => prev.map(loan => {
                if (loan.id !== id) return loan;
                let updatedLoan = { ...loan, [field]: value }; // Remove Number() cast for boolean
                if (field !== 'enableMargin' && field !== 'repayAtMaturity') updatedLoan[field] = Number(value); // Cast numbers
                
                if (field === 'years') {
                    if (updatedLoan.grace > value) {
                        updatedLoan.grace = value;
                    }
                }
                return updatedLoan;
                }));
            }, []);

            const [viewMode, setViewMode] = useState('netWorth');
            const [visibleSeries, setVisibleSeries] = useState({ leveraged: true, noLoan: true });
            const toggleSeries = (key) => {
                setVisibleSeries(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const [simResults, setSimResults] = useState([]); 
            const [chartDataNW, setChartDataNW] = useState([]); 
            const [chartDataLev, setChartDataLev] = useState([]); 
            const [chartDataProb, setChartDataProb] = useState([]); 
            const [chartDataSurvival, setChartDataSurvival] = useState([]);
            
            const [auditData, setAuditData] = useState([]);
            const [selectedUniverseId, setSelectedUniverseId] = useState(null);
            const [selectedUniverseIndex, setSelectedUniverseIndex] = useState(-1);
            const [isSimulating, setIsSimulating] = useState(true);

            const [stats, setStats] = useState({
                levROI: { p10: 0, p50: 0, p90: 0, stdDev: 0, irrP50: 0, p10NetWorth: 0 },
                baseROI: { p10: 0, p50: 0, p90: 0, stdDev: 0, irrP50: 0, p10NetWorth: 0 },
                timeStats: { lev: {}, base: {}, integralDiff: 0 },
                leverageAdvantage: 0,
                totalInvested: 0,
                isIdentical: false,
                avgLoanRate: 0,
                breakevenRank: 0,
                levFinal: [],
                baseFinal: [],
                rawPaths: null,
                sortedIndices: [],
                ruinProbLev: 0 
            });

            const [cashFlowStatus, setCashFlowStatus] = useState({
                hasNegativeFlow: false,
                firstNegativeYear: null,
                initialMonthlyDeficit: 0, 
                maxMonthlyDeficit: 0,      
                maxDeficitYear: 0,        
                durationYears: 0,
                paymentAtMaxDeficit: 0,
                savingsAtMaxDeficit: 0 
            });

            const [showAudit, setShowAudit] = useState(false); 

            const totalLoanAmount = loans.reduce((acc, curr) => acc + curr.amount, 0);
            
            const analysisReport = useMemo(() => {
                const { levROI, baseROI, leverageAdvantage, totalInvested, isIdentical, avgLoanRate, ruinProbLev } = stats;

                if (isIdentical) {
                    return {
                        title: "ç„¡æ§“æ¡¿ç‹€æ…‹ (No Leverage)",
                        colorClass: "text-slate-600",
                        bgClass: "bg-slate-50 border-slate-200",
                        icon: Info,
                        desc: "ç›®å‰è²¸æ¬¾é‡‘é¡ç‚º 0ï¼Œç­–ç•¥ç›¸åŒã€‚è«‹å˜—è©¦å¢åŠ è²¸æ¬¾é‡‘é¡ä»¥è§€å¯Ÿæ§“æ¡¿æ•ˆæ‡‰ã€‚",
                        factors: []
                    };
                }
                
                const riskFactors = [];
                const spread = cagr - avgLoanRate;
                if (spread < 2.0 && totalLoanAmount > 0) riskFactors.push({ label: "åˆ©å·®éå°", val: `${spread.toFixed(1)}%`, isBad: true });
                
                const volDrag = 0.5 * Math.pow(volatility / 100, 2) * 100;
                if (volatility > 18) riskFactors.push({ label: "æ³¢å‹•æ‹–ç´¯", val: `-${volDrag.toFixed(1)}%`, isBad: true });

                if (ruinProbLev > 0) riskFactors.push({ label: "å­˜åœ¨ç ´ç”¢é¢¨éšª", val: `${ruinProbLev.toFixed(1)}%`, isBad: true });
                if (ruinProbLev > 5) riskFactors.push({ label: "ç”Ÿå­˜ç‡æ¥µä½", val: "Critical", isBad: true });

                const isP10Survived = levROI.p10NetWorth > 0;
                const isP10Healthy = levROI.p10NetWorth > (totalInvested * 0.5); 
                const isWinRateGood = leverageAdvantage >= 60;
                const yieldSpread = levROI.irrP50 - baseROI.irrP50;
                const isSpreadAttractive = yieldSpread >= 2.0;

                let title, colorClass, bgClass, icon, desc;

                if (ruinProbLev >= 50) {
                     title = "è‡ªæ®ºå¼ç­–ç•¥ (Suicidal)";
                     colorClass = "text-slate-900";
                     bgClass = "bg-slate-200 border-slate-300 from-slate-100 to-white";
                     icon = Skull;
                     desc = `å³ä½¿åœ¨æˆ¿è²¸å‹èè³‡ä¸‹ï¼Œæ­¤ç­–ç•¥ä»æœ‰è¶…éä¸€åŠçš„æ©Ÿç‡å°è‡´æŠ•è³‡éƒ¨ä½å…¨æ•¸æ­¸é›¶ (${ruinProbLev.toFixed(1)}%)ï¼Œé€™è¡¨ç¤ºæ§“æ¡¿éé«˜æˆ–ç¾é‡‘æµå®Œå…¨æ¯ç«­ã€‚`;
                } else if (ruinProbLev > 1) {
                    title = "é«˜é¢¨éšªç­–ç•¥ (High Risk)";
                    colorClass = "text-red-700";
                    bgClass = "bg-red-50 border-red-200 from-red-50 to-white";
                    icon = AlertTriangle;
                    desc = `è­¦å‘Šï¼šå­˜åœ¨ ${ruinProbLev.toFixed(1)}% çš„æ©Ÿç‡å°è‡´æŠ•è³‡éƒ¨ä½æ­¸é›¶ã€‚é›–ç„¶æˆ¿è²¸ä¸æœƒè¢«æ–·é ­ï¼Œä½†è³‡ç”¢ä¸€æ—¦æ­¸é›¶ï¼Œå†å¤šçš„æ™‚é–“ä¹Ÿç„¡æ³•æ¼²å›ï¼Œåªèƒ½é æ–°è³‡é‡‘é‡ä¾†ã€‚`;
                } else if (!isWinRateGood) {
                    title = "å‹ç‡åä½ (Inefficient)";
                    colorClass = "text-slate-700";
                    bgClass = "bg-slate-100 border-slate-200 from-slate-50 to-white";
                    icon = ThumbsDown;
                    desc = "æ¨¡æ“¬é¡¯ç¤ºå‹ç‡ä½æ–¼ 60%ã€‚å¯èƒ½åŸå› ï¼šåˆ©å·®ç·©è¡ä¸è¶³ã€é‚„æ¬¾å£“åŠ›éå¤§ï¼Œæˆ–æ˜¯æ³¢å‹•ç‡æ‹–ç´¯æ•ˆæ‡‰é¡¯è‘—ã€‚";
                } else if (!isP10Healthy) {
                    title = "æ½›æ°´é¢¨éšª (Under Water)";
                    colorClass = "text-orange-700";
                    bgClass = "bg-orange-50 border-orange-200 from-orange-50 to-white";
                    icon = Anchor;
                    desc = "åœ¨æ‚²è§€æƒ…å¢ƒ (P10) ä¸‹ï¼Œæ‚¨çš„è³‡ç”¢å°‡é•·æœŸè™•æ–¼ã€Œè² è³‡ç”¢ã€ç‹€æ…‹ï¼ˆå¸‚å€¼ < æˆ¿è²¸é¤˜é¡ï¼‰ã€‚é›–ç„¶ä¸æœƒè¢«æ–·é ­ï¼Œä½†éœ€è¦æ¥µå¼·çš„å¿ƒç†ç´ è³ªæ’éæ¼«é•·çš„æ°´ä¸‹æœŸã€‚";
                } else if (isWinRateGood && isSpreadAttractive) {
                    title = "è–æ¯å€ (The Sweet Spot)";
                    colorClass = "text-emerald-700";
                    bgClass = "bg-emerald-50 border-emerald-200 from-emerald-50 to-white";
                    icon = Zap;
                    desc = "å®Œç¾ï¼é€™æ˜¯ä¸€å€‹é«˜éŸŒæ€§çš„æˆ¿è²¸æŠ•è³‡ç­–ç•¥ã€‚ç”Ÿå­˜ç‡æ¥µé«˜ (0% æ­¸é›¶)ï¼Œä¸”åœ¨é•·æœŸæ™‚é–“ä¸‹èƒ½æœ‰æ•ˆåˆ©ç”¨ä½æ¯è³‡é‡‘å‰µé€ è¶…é¡å ±é…¬ã€‚";
                } else {
                    title = "ç©©å¥ç­–ç•¥ (Solid)";
                    colorClass = "text-indigo-700";
                    bgClass = "bg-indigo-50 border-indigo-200 from-indigo-50 to-white";
                    icon = ThumbsUp;
                    desc = "ç­–ç•¥é«”è³ªå¥åº·ã€‚åˆ©ç”¨æˆ¿è²¸çš„ã€Œä¸æ–·é ­ã€ç‰¹æ€§ï¼Œé•·æœŸæŒæœ‰å‹ç®—å¾ˆé«˜ã€‚";
                }

                return { title, colorClass, bgClass, icon, desc, factors: riskFactors };
            }, [stats, cagr, volatility, years, loans]);

            const AnalysisIcon = analysisReport.icon;

            useEffect(() => {
                setIsSimulating(true);
                setSelectedUniverseId(null); 
                setSelectedUniverseIndex(-1);

                const timer = setTimeout(() => {
                    const runSimulationEngine = () => {
                        const dt = 1 / 12; 
                        const totalSteps = years * 12;
                        
                        let negMonthCount = 0;
                        let hasNegFlow = false;
                        let firstNegYear = null;
                        let maxDeficit = 0;
                        let maxDeficitYear = 0;
                        let paymentAtMaxDeficit = 0;
                        let savingsAtMaxDeficit = 0;
                        let initialDeficitValue = 0;
                        
                        let totalInvestedPrincipal = Number(initialCapital);
                        const monthlySavingsNum = Number(monthlySavings);
                        const savingsGrowthRateNum = Number(savingsGrowthRate);
                        const targetAmt = Number(targetAmount);

                        const loanSchedules = loans.map(loan => calculateLoanSchedule(loan, totalSteps));
                        const aggregateSchedule = new Array(totalSteps).fill(null).map((_, t) => {
                            let totalPayment = 0, totalPrincipalRed = 0;
                            loans.forEach((loan, idx) => {
                            const stepInfo = loanSchedules[idx][t]; 
                            if (stepInfo) {
                                totalPayment += stepInfo.payment;
                                totalPrincipalRed += stepInfo.principal;
                            }
                            });
                            return { totalPayment, totalPrincipalRed };
                        });

                        // Calculate Repayment at Maturity Schedule (Balloon Payments) & Identify Margin Loans
                        const repaymentSchedule = new Float32Array(totalSteps + 1).fill(0);
                        const marginRepaymentSchedule = new Float32Array(totalSteps + 1).fill(0); // Track Margin repayments specifically

                        loans.forEach(loan => {
                            if (loan.amount > 0 && loan.grace >= loan.years && loan.repayAtMaturity) {
                                const maturityStep = loan.years * 12;
                                if (maturityStep <= totalSteps) {
                                    repaymentSchedule[maturityStep] += loan.amount;
                                    if(loan.enableMargin) {
                                        marginRepaymentSchedule[maturityStep] += loan.amount; // Add to margin repayment track
                                    }
                                }
                            }
                        });

                        initialDeficitValue = Math.max(0, aggregateSchedule[0].totalPayment - monthlySavingsNum);

                        for (let t = 0; t < totalSteps; t++) {
                            const currentMonthlyInjection = monthlySavingsNum * Math.pow(1 + savingsGrowthRateNum / 100, t / 12);
                            totalInvestedPrincipal += currentMonthlyInjection;
                            
                            const totalPayment = aggregateSchedule[t].totalPayment;
                            const net = currentMonthlyInjection - totalPayment;
                            
                            if (net < -0.001) {
                                hasNegFlow = true;
                                negMonthCount++;
                                if (firstNegYear === null) firstNegYear = (t / 12).toFixed(1);
                                if (Math.abs(net) > maxDeficit) {
                                    maxDeficit = Math.abs(net);
                                    maxDeficitYear = (t / 12).toFixed(1);
                                    paymentAtMaxDeficit = totalPayment;
                                    savingsAtMaxDeficit = currentMonthlyInjection;
                                }
                            }
                        }

                        const cumulativePrincipalLine = new Float32Array(totalSteps + 1);
                        let runningPrincipal = Number(initialCapital);
                        cumulativePrincipalLine[0] = Number(initialCapital);
                        for(let t=0; t<totalSteps; t++) {
                            const currentMonthlyInjection = monthlySavingsNum * Math.pow(1 + savingsGrowthRateNum / 100, t / 12);
                            runningPrincipal += currentMonthlyInjection;
                            cumulativePrincipalLine[t+1] = runningPrincipal;
                        }
                        const finalTotalInvested = cumulativePrincipalLine[totalSteps];
                        
                        let totalLoanAmt = 0;
                        let weightedRateSum = 0;
                        let initialMarginDebtTotal = 0; 

                        loans.forEach(l => {
                            if (l.amount > 0) {
                                totalLoanAmt += l.amount;
                                weightedRateSum += l.amount * l.rate;
                                if (l.enableMargin) {
                                    initialMarginDebtTotal += l.amount; 
                                }
                            }
                        });
                        const avgLoanRate = totalLoanAmt > 0 ? weightedRateSum / totalLoanAmt : 0;

                        const allUniverses = [];
                        const EPSILON = 1; 
                        const isIdentical = totalLoanAmt === 0;

                        const survivalCountsLev = new Int32Array(totalSteps + 1).fill(0);
                        const survivalCountsBase = new Int32Array(totalSteps + 1).fill(0);

                        for (let i = 0; i < simulationCount; i++) {
                            const pathLevNW = new Float32Array(totalSteps + 1);
                            const pathLevGA = new Float32Array(totalSteps + 1);
                            const pathBaseNW = new Float32Array(totalSteps + 1);
                            const pathBaseGA = new Float32Array(totalSteps + 1);

                            let currentGrossAsset = Number(initialCapital) + totalLoanAmt; 
                            let currentTotalLoanBalance = totalLoanAmt;
                            let currentMarginDebt = initialMarginDebtTotal; // Track margin debt dynamically per universe           
                            let currentBaseAsset = Number(initialCapital);                  

                            pathLevNW[0] = currentGrossAsset - currentTotalLoanBalance;
                            pathLevGA[0] = currentGrossAsset;
                            pathBaseNW[0] = currentBaseAsset;
                            pathBaseGA[0] = currentBaseAsset;

                            if (pathLevGA[0] > 0) survivalCountsLev[0]++;
                            if (pathBaseGA[0] > 0) survivalCountsBase[0]++;

                            let hasGoneBust = false;
                            let bustYear = null; 
                            let accumulatedInterest = 0;
                            let hitTargetLev = null; 
                            let hitTargetBase = null;

                            if (pathLevNW[0] >= targetAmt) hitTargetLev = 0;
                            if (pathBaseNW[0] >= targetAmt) hitTargetBase = 0;

                            for (let t = 0; t < totalSteps; t++) {
                                const schedule = aggregateSchedule[t];
                                const Z = randn_bm(); 
                                const mu = cagr / 100;
                                const sigma = volatility / 100;
                                const currentMonthlyInjection = monthlySavingsNum * Math.pow(1 + savingsGrowthRateNum / 100, t / 12);

                                const drift = (mu) * dt; 
                                const diffusion = sigma * Math.sqrt(dt) * Z;
                                const growthFactor = Math.exp(drift + diffusion);

                                // Leveraged
                                if (!hasGoneBust) {
                                    let marketGrowthLev = 0;
                                    if (currentGrossAsset > 0) marketGrowthLev = currentGrossAsset * (growthFactor - 1);
                                    
                                    currentGrossAsset += marketGrowthLev;
                                    currentGrossAsset += (currentMonthlyInjection - schedule.totalPayment);
                                    currentTotalLoanBalance -= schedule.totalPrincipalRed;
                                    
                                    // Handle Repayment at Maturity (Balloon Payment)
                                    // Also reduce currentMarginDebt if the repaid loan was a margin loan
                                    if (repaymentSchedule[t+1] > 0) {
                                        const repaymentAmount = repaymentSchedule[t+1];
                                        currentGrossAsset -= repaymentAmount;
                                        currentTotalLoanBalance -= repaymentAmount;
                                        
                                        // Reduce margin debt balance if applicable
                                        if (marginRepaymentSchedule[t+1] > 0) {
                                            currentMarginDebt -= marginRepaymentSchedule[t+1];
                                        }
                                    }

                                    const interestPaid = schedule.totalPayment - schedule.totalPrincipalRed;
                                    accumulatedInterest += interestPaid;
                                    const netWorth = currentGrossAsset - currentTotalLoanBalance;
                                    
                                    // 1. Absolute Ruin (Assets gone)
                                    if (currentGrossAsset <= 0.01) {
                                        hasGoneBust = true;
                                        bustYear = (t+1)/12; 
                                        currentGrossAsset = 0; 
                                    }

                                    // 2. Margin Call Logic (Using dynamic currentMarginDebt)
                                    if (!hasGoneBust && currentMarginDebt > 0) {
                                        const currentRatio = (currentGrossAsset / currentMarginDebt) * 100;
                                        for (const loan of loans) {
                                            if (loan.amount > 0 && loan.enableMargin && currentRatio < loan.maintenanceMargin) {
                                                hasGoneBust = true;
                                                currentGrossAsset = 0; 
                                                break;
                                            }
                                        }
                                    }
                                    
                                    pathLevNW[t+1] = netWorth;
                                    pathLevGA[t+1] = currentGrossAsset;
                                } else {
                                    currentTotalLoanBalance -= schedule.totalPrincipalRed;
                                    pathLevNW[t+1] = -currentTotalLoanBalance;
                                    pathLevGA[t+1] = 0;
                                }
                                
                                if (!hasGoneBust) survivalCountsLev[t+1]++;

                                // Base
                                let marketGrowthBase = 0;
                                if (currentBaseAsset > 0) marketGrowthBase = currentBaseAsset * (growthFactor - 1);
                                currentBaseAsset += marketGrowthBase;
                                currentBaseAsset += currentMonthlyInjection;

                                pathBaseNW[t+1] = currentBaseAsset;
                                pathBaseGA[t+1] = currentBaseAsset;
                                if (currentBaseAsset > 0) survivalCountsBase[t+1]++;

                                if (hitTargetLev === null && !hasGoneBust && pathLevNW[t+1] >= targetAmt) hitTargetLev = (t+1)/12;
                                if (hitTargetBase === null && currentBaseAsset >= targetAmt) hitTargetBase = (t+1)/12;
                            }
                            
                            const finalLevNet = pathLevNW[totalSteps];
                            const finalBaseNet = pathBaseNW[totalSteps];
                            
                            let winner = 'tie';
                            if (!isIdentical) {
                                if (finalLevNet > (finalBaseNet + EPSILON) && !hasGoneBust) winner = 'lev';
                                else if (finalBaseNet > (finalLevNet + EPSILON)) winner = 'base';
                            } else { }

                            allUniverses.push({
                                id: i + 1,
                                pathLevNW, pathLevGA,
                                pathBaseNW, pathBaseGA,
                                finalLevNet, finalBaseNet,
                                levROI: ((finalLevNet - finalTotalInvested) / finalTotalInvested) * 100,
                                baseROI: ((finalBaseNet - finalTotalInvested) / finalTotalInvested) * 100,
                                isZombie: hasGoneBust,
                                bustYear,
                                totalInterest: accumulatedInterest,
                                winner,
                                alpha: finalLevNet - finalBaseNet,
                                hitTargetLev,
                                hitTargetBase
                            });
                        }

                        return {
                            allUniverses, finalTotalInvested, cumulativePrincipalLine, totalSteps, avgLoanRate, isIdentical, survivalCountsLev, survivalCountsBase, cashFlowData: { hasNegativeFlow: hasNegFlow, firstNegativeYear: firstNegYear, initialMonthlyDeficit: initialDeficitValue, maxMonthlyDeficit: maxDeficit, maxDeficitYear: maxDeficitYear, durationYears: (negMonthCount / 12).toFixed(1), paymentAtMaxDeficit, savingsAtMaxDeficit }
                        };
                    }; 

                    const result = runSimulationEngine();
                    const { allUniverses, finalTotalInvested, cumulativePrincipalLine, totalSteps, avgLoanRate, isIdentical, cashFlowData, survivalCountsLev, survivalCountsBase } = result;

                    setCashFlowStatus(cashFlowData);
                    setSimResults(allUniverses);

                    const sortedLevROIs = [...allUniverses].map(r => r.levROI).sort((a, b) => a - b);
                    const sortedBaseROIs = [...allUniverses].map(r => r.baseROI).sort((a, b) => a - b);
                    const getP = (arr, p) => arr[Math.floor(arr.length * p)];
                    
                    const sortedLevNet = [...allUniverses].map(r => r.finalLevNet).sort((a, b) => a - b);
                    const sortedBaseNet = [...allUniverses].map(r => r.finalBaseNet).sort((a, b) => a - b);

                    const getStats = (arr) => {
                        const valid = arr.filter(x => x !== null).sort((a,b) => a-b);
                        if (valid.length === 0) return { p10: null, p50: null, p90: null, avg: null, successRate: 0 };
                        const sum = valid.reduce((a,b) => a+b, 0);
                        return {
                            p10: valid[Math.floor(valid.length * 0.1)],
                            p50: valid[Math.floor(valid.length * 0.5)],
                            p90: valid[Math.floor(valid.length * 0.9)],
                            avg: sum / valid.length,
                            successRate: (valid.length / arr.length) * 100,
                            min: valid[0],
                            max: valid[valid.length - 1]
                        };
                    };
                    const timeStatsLev = getStats(allUniverses.map(u => u.hitTargetLev));
                    const timeStatsBase = getStats(allUniverses.map(u => u.hitTargetBase));

                    let integralDiff = 0;
                    const stepSize = 1/12;
                    for(let t=0; t < totalSteps; t++) {
                        const tYears = t/12;
                        const hitCountLev = allUniverses.filter(u => u.hitTargetLev !== null && u.hitTargetLev <= tYears).length;
                        const probLev = hitCountLev / simulationCount;
                        const hitCountBase = allUniverses.filter(u => u.hitTargetBase !== null && u.hitTargetBase <= tYears).length;
                        const probBase = hitCountBase / simulationCount;
                        integralDiff += (probLev - probBase) * stepSize;
                    }

                    const timeStats = { lev: timeStatsLev, base: timeStatsBase, integralDiff: integralDiff };

                    const levStats = {
                        p10: getP(sortedLevROIs, 0.1),
                        p50: getP(sortedLevROIs, 0.5),
                        p90: getP(sortedLevROIs, 0.9),
                        stdDev: calculateStdDev(sortedLevROIs),
                        p10NetWorth: sortedLevNet[Math.floor(simulationCount * 0.1)]
                    };
                    
                    const p50LevFinal = sortedLevNet[Math.floor(simulationCount*0.5)];
                    levStats.irrP50 = calculateIRR(initialCapital, Number(monthlySavings), Number(savingsGrowthRate), years, p50LevFinal);

                    const baseStats = {
                        p10: getP(sortedBaseROIs, 0.1),
                        p50: getP(sortedBaseROIs, 0.5),
                        p90: getP(sortedBaseROIs, 0.9),
                        stdDev: calculateStdDev(sortedBaseROIs),
                    };
                    const p50BaseFinal = sortedBaseNet[Math.floor(simulationCount*0.5)];
                    baseStats.irrP50 = calculateIRR(initialCapital, Number(monthlySavings), Number(savingsGrowthRate), years, p50BaseFinal);

                    const wins = allUniverses.filter(r => r.winner === 'lev').length;
                    const advProb = (wins / simulationCount) * 100;
                    const ruinCount = allUniverses.filter(r => r.isZombie).length;
                    const ruinProbLev = (ruinCount / simulationCount) * 100;

                    const rankingMap = allUniverses.map((r, idx) => ({ alpha: r.alpha, originalIdx: idx }));
                    rankingMap.sort((a, b) => a.alpha - b.alpha);
                    const sortedIndices = rankingMap.map(item => item.originalIdx);

                    const firstWinRank = rankingMap.findIndex(item => item.alpha > 0);
                    const breakevenRank = firstWinRank === -1 ? simulationCount + 1 : firstWinRank + 1;

                    const auditLog = [];
                    const indicesToLog = new Set();
                    for(let k=0; k < Math.min(simulationCount, 10); k++) indicesToLog.add(k); 
                    for(let k=0; k < 10; k++) indicesToLog.add(Math.floor(Math.random() * simulationCount));
                    indicesToLog.forEach(idx => auditLog.push(allUniverses[idx]));
                    setAuditData(auditLog);

                    const bgIndices = [];
                    const numPathsToShow = 50;
                    for (let i = 0; i < numPathsToShow; i++) {
                        const rank = Math.floor(i * (simulationCount - 1) / (numPathsToShow - 1));
                        bgIndices.push(sortedIndices[rank]);
                    }

                    const processChartData = (type) => {
                        const stats = [];
                        const sortedByLevFinal = [...allUniverses].sort((a, b) => a.finalLevNet - b.finalLevNet);
                        const medianLevUniverse = sortedByLevFinal[Math.floor(simulationCount * 0.5)] || sortedByLevFinal[0]; 
                        const sortedByBaseFinal = [...allUniverses].sort((a, b) => a.finalBaseNet - b.finalBaseNet);
                        const medianBaseUniverse = sortedByBaseFinal[Math.floor(simulationCount * 0.5)] || sortedByBaseFinal[0];

                        for(let t=0; t <= totalSteps; t++) {
                            let p50Lev, p50Base;
                            let probLev = 0, probBase = 0;
                            let survivalLev = 0, survivalBase = 0;

                            if (type === 'SURVIVAL') {
                                survivalLev = (survivalCountsLev[t] / simulationCount) * 100;
                                survivalBase = (survivalCountsBase[t] / simulationCount) * 100;
                                p50Lev = survivalLev;
                                p50Base = survivalBase;
                            } else if (type === 'PROB') {
                                const hitCountLev = allUniverses.filter(u => u.hitTargetLev !== null && u.hitTargetLev <= t/12).length;
                                probLev = (hitCountLev / simulationCount) * 100;
                                const hitCountBase = allUniverses.filter(u => u.hitTargetBase !== null && u.hitTargetBase <= t/12).length;
                                probBase = (hitCountBase / simulationCount) * 100;
                                p50Lev = probLev;
                                p50Base = probBase;
                            } else if (type === 'NW') {
                                p50Lev = medianLevUniverse ? medianLevUniverse.pathLevNW[t] : 0;
                                p50Base = medianBaseUniverse ? medianBaseUniverse.pathBaseNW[t] : 0;
                            } else {
                                const levNW = medianLevUniverse ? medianLevUniverse.pathLevNW[t] : 0;
                                const levGA = medianLevUniverse ? medianLevUniverse.pathLevGA[t] : 0;
                                p50Lev = levNW <= 0 ? 999 : levGA / levNW;
                                const baseNW = medianBaseUniverse ? medianBaseUniverse.pathBaseNW[t] : 0;
                                const baseGA = medianBaseUniverse ? medianBaseUniverse.pathBaseGA[t] : 0;
                                p50Base = baseNW <= 0 ? 999 : baseGA / baseNW;
                            }

                            const point = {
                                month: t,
                                year: (t/12).toFixed(1),
                                p50Lev, p50Base,
                                survivalLev, survivalBase,
                                principal: cumulativePrincipalLine[t]
                            };

                            if (type !== 'PROB' && type !== 'SURVIVAL') {
                                bgIndices.forEach((pathIdx, i) => {
                                    const u = allUniverses[pathIdx];
                                    if (!u) return;
                                    if (type === 'NW') {
                                        point[`lev_bg_${i}`] = u.pathLevNW[t];
                                        point[`base_bg_${i}`] = u.pathBaseNW[t];
                                    } else {
                                        point[`lev_bg_${i}`] = u.pathLevNW[t] <= 0 ? 999 : u.pathLevGA[t] / u.pathLevNW[t];
                                        point[`base_bg_${i}`] = u.pathBaseNW[t] <= 0 ? 999 : u.pathBaseGA[t] / u.pathBaseNW[t];
                                    }
                                });
                            }
                            stats.push(point);
                        }
                        return stats;
                    };

                    const nwData = processChartData('NW');
                    const levData = processChartData('LEV'); 
                    const probData = processChartData('PROB');
                    const survivalData = processChartData('SURVIVAL');

                    setChartDataNW(nwData);
                    setChartDataLev(levData); 
                    setChartDataProb(probData);
                    setChartDataSurvival(survivalData);

                    setStats({ 
                        levROI: levStats, baseROI: baseStats, leverageAdvantage: advProb, totalInvested: finalTotalInvested, isIdentical, avgLoanRate, 
                        sortedIndices, breakevenRank, timeStats, ruinProbLev,
                        rawPaths: { lev: allUniverses.map(u => u.pathLevNW), base: allUniverses.map(u => u.pathBaseNW), levGA: allUniverses.map(u => u.pathLevGA), baseGA: allUniverses.map(u => u.pathBaseGA) },
                        levFinal: allUniverses, baseFinal: allUniverses.map(u => u.finalBaseNet)
                    });
                    
                    setIsSimulating(false);
                }, 10);
                return () => clearTimeout(timer);
            }, [initialCapital, loans, cagr, volatility, years, simulationCount, monthlySavings, savingsGrowthRate, targetAmount]);

            const displayData = useMemo(() => {
                if (isSimulating) return [];
                let baseData;
                if (viewMode === 'survival') baseData = chartDataSurvival;
                else if (viewMode === 'netWorth') baseData = chartDataNW;
                else if (viewMode === 'leverage') baseData = chartDataLev;
                else baseData = chartDataProb;

                if (!baseData || baseData.length === 0) return [];
                
                const isAggregateMode = viewMode === 'survival' || viewMode === 'targetProb';

                if (selectedUniverseId !== null && simResults.length > 0 && !isAggregateMode) {
                    const target = simResults[selectedUniverseId - 1];
                    if (target) {
                        return baseData.map((d, t) => {
                            const pLevNW = target.pathLevNW[t];
                            const pLevGA = target.pathLevGA[t];
                            const pBaseNW = target.pathBaseNW[t];
                            const pBaseGA = target.pathBaseGA[t];

                            let focusLevVal, focusBaseVal;
                            if (viewMode === 'netWorth') {
                                focusLevVal = pLevNW;
                                focusBaseVal = pBaseNW;
                            } else {
                                focusLevVal = pLevNW <= 0 ? 999 : pLevGA / pLevNW;
                                focusBaseVal = pBaseNW <= 0 ? 999 : pBaseGA / pBaseNW;
                            }
                            return { ...d, focusLev: focusLevVal, focusBase: focusBaseVal };
                        });
                    }
                }
                return baseData;
            }, [selectedUniverseId, chartDataNW, chartDataLev, chartDataProb, chartDataSurvival, simResults, viewMode, isSimulating]);

            const handleSliderChange = (rank) => {
                if (!stats.sortedIndices || stats.sortedIndices.length === 0) return;
                const arrIndex = Math.min(Math.max(0, rank - 1), simulationCount - 1);
                const originalIdx = stats.sortedIndices[arrIndex];
                setSelectedUniverseId(originalIdx + 1); 
                setSelectedUniverseIndex(rank);
                if (viewMode === 'survival' || viewMode === 'targetProb') setViewMode('netWorth');
            };
            
            const handleRowClick = (id) => {
                setSelectedUniverseId(id);
                const originalIdx = id - 1;
                const rankIndex = stats.sortedIndices.indexOf(originalIdx);
                if (rankIndex !== -1) setSelectedUniverseIndex(rankIndex + 1);
                if (viewMode === 'survival' || viewMode === 'targetProb') setViewMode('netWorth');
                window.scrollTo({ top: 300, behavior: 'smooth' });
            };
            
            const currentRank = useMemo(() => {
                if (selectedUniverseId === null) return -1;
                if (selectedUniverseIndex !== -1) return selectedUniverseIndex;
                const originalIdx = selectedUniverseId - 1;
                const rankIndex = stats.sortedIndices.indexOf(originalIdx);
                return rankIndex + 1;
            }, [selectedUniverseId, selectedUniverseIndex, stats.sortedIndices]);
            
            const sliderValue = currentRank === -1 ? 0 : currentRank;
            const formatPercent = (val) => { const v = Number(val); return (v > 0 ? '+' : '') + v.toFixed(1) + '%'; };

            return (
                <div className="min-h-screen bg-slate-50/50 p-4 md:p-8 font-sans text-slate-800">
                <div className="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                    <h1 className="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight flex items-center gap-3">
                        <div className="p-2 bg-indigo-600 rounded-lg text-white shadow-md"> <Activity size={24} /> </div>
                        å¢è²¸æŠ•è³‡å£“åŠ›æ¸¬è©¦æ¨¡æ“¬å™¨ v2.17
                    </h1>
                    <p className="text-slate-500 mt-2 text-sm md:text-base font-medium"> æˆ¿è²¸å‹æŠ•è³‡éŸŒæ€§åˆ†æ: <span className="text-indigo-600 font-bold">ä¸æ–·é ­æ¨¡å‹ (Non-Callable)</span> </p>
                    </div>
                </div>

                <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <div className="lg:col-span-3 space-y-5">
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-slate-50 px-5 py-3 border-b border-slate-200 flex items-center gap-2">
                                <Wallet className="w-4 h-4 text-indigo-600" />
                                <h3 className="font-bold text-slate-700 text-sm">è‡ªæœ‰è³‡é‡‘èˆ‡ç¾é‡‘æµ</h3>
                            </div>
                            <div className="p-5 space-y-5">
                                <div> <label className="text-xs font-bold text-slate-600 mb-1.5 block">åˆå§‹è‡ªæœ‰è³‡é‡‘ (Initial Equity)</label> <InputSlider value={initialCapital} setter={setInitialCapital} min={100} max={5000} step={50} suffix="" enableInput={true} /> </div>
                                <div> <label className="text-xs font-bold text-slate-600 mb-1.5 block">æ¯æœˆå„²è“„æŠ•å…¥ (è¬)</label> <InputSlider value={monthlySavings} setter={setMonthlySavings} min={0} max={100} step={1} suffix="" enableInput={true} /> </div>
                                <div> <label className="text-xs font-bold text-slate-600 mb-1.5 block">å„²è“„å¹´æˆé•·ç‡ (%)</label> <InputSlider value={savingsGrowthRate} setter={setSavingsGrowthRate} min={0} max={10} step={0.5} suffix="" enableInput={true} /> </div>
                                <div> <label className="text-xs font-bold text-slate-600 mb-1.5 block">ğŸ¯ ç›®æ¨™é‡‘é¡ (è¬)</label> <InputSlider value={targetAmount} setter={setTargetAmount} min={500} max={10000} step={50} suffix="" enableInput={true} /> </div>
                            </div>
                        </div>

                        <div className="bg-slate-100/50 rounded-2xl p-2 border border-slate-200/60">
                            <div className="px-3 py-2 flex items-center justify-between mb-2">
                                <h3 className="font-bold text-slate-700 text-sm flex items-center gap-2"> <Landmark className="w-4 h-4 text-indigo-600" /> è²¸æ¬¾çµ„åˆ (å…¨é¡æŠ•å…¥) </h3>
                                <span className="text-[10px] bg-slate-200 px-2 py-0.5 rounded-full text-slate-600 font-bold">ç¸½è²¸: {totalLoanAmount}è¬</span>
                            </div>
                            <div className="space-y-2"> {loans.map(loan => ( <LoanCard key={loan.id} loan={loan} onUpdate={updateLoan} /> ))} </div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-slate-700 text-sm flex items-center gap-2"> <TrendingUp className="w-4 h-4 text-indigo-600" /> å¸‚å ´æ¨¡æ“¬åƒæ•¸ </h3>
                                {!stressTestActive ? (
                                    <button onClick={triggerStressTest} className="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded border border-red-100 hover:bg-red-100 font-bold flex items-center gap-1 transition-colors">
                                        <Bomb size={12} /> å£“åŠ›æ¸¬è©¦
                                    </button>
                                ) : (
                                    <button onClick={restoreSettings} className="text-[10px] bg-teal-50 text-teal-600 px-2 py-1 rounded border border-teal-100 hover:bg-teal-100 font-bold flex items-center gap-1 transition-colors shadow-sm ring-2 ring-teal-500/20">
                                        <RotateCcw size={12} /> é‚„åŸè¨­å®š
                                    </button>
                                )}
                            </div>
                            <div className={`space-y-5 transition-opacity duration-300 ${stressTestActive ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                                <div> <label className="text-xs font-bold text-slate-600 mb-1.5 block">é æœŸå¹´åŒ–å ±é…¬ (å¹¾ä½•å¹³å‡) %</label> <InputSlider value={cagr} setter={setCagr} min={-5} max={20} step={0.5} suffix="" enableInput={true} /> </div>
                                <div> <label className="text-xs font-bold text-slate-600 mb-1.5 block">æ³¢å‹•ç‡ (Risk) %</label> <InputSlider value={volatility} setter={setVolatility} min={5} max={50} step={1} suffix="" enableInput={true} /> </div>
                                <div> <label className="text-xs font-bold text-slate-600 mb-1.5 block flex justify-between"> <span>æ¨¡æ“¬å¹´é™ (å¹´)</span> <span className="text-[10px] font-normal text-slate-400">æ¨¡æ“¬é•·æœŸæŠ•è³‡è«‹é¸æ“‡30å¹´</span> </label> <InputSlider value={years} setter={setYears} min={1} max={30} step={1} suffix="" enableInput={true} /> </div>
                                <div> <label className="text-xs font-bold text-slate-600 mb-1.5 block flex justify-between"> <span>æ¨¡æ“¬è·¯å¾‘æ¬¡æ•¸ (Paths)</span> <span className="text-[10px] font-normal text-slate-400">è¶Šé«˜è¶Šç²¾ç¢ºä½†è¼ƒæ…¢</span> </label> <InputSlider value={simulationCount} setter={setSimulationCount} min={100} max={2000} step={100} suffix="" enableInput={true} /> </div>
                            </div>
                        </div>
                    </div>

                    <div className="lg:col-span-9 space-y-6">
                    <div className={`rounded-2xl border p-0 overflow-hidden shadow-md bg-white`}>
                            <div className={`p-6 flex flex-col md:flex-row items-start gap-8 bg-gradient-to-br ${analysisReport.bgClass}`}>
                                <div className="flex flex-col items-center justify-center shrink-0 pr-0 md:pr-8 md:border-r border-black/5 min-w-[160px] self-center">
                                    <span className="text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">æ¨¡æ“¬å‹ç‡ (Simulated Win Rate)</span>
                                    <div className={`text-5xl font-black tracking-tighter ${analysisReport.colorClass}`}> {stats.isIdentical ? '-' : stats.leverageAdvantage.toFixed(1)}<span className="text-xl ml-1 font-bold">{stats.isIdentical ? '' : '%'}</span> </div>
                                </div>
                                <div className="flex-1">
                                    <div className="flex items-center gap-3 mb-3">
                                        <div className={`p-2 rounded-full bg-white shadow-sm ring-1 ring-black/5 ${analysisReport.colorClass}`}> <AnalysisIcon className="w-5 h-5" /> </div>
                                        <h4 className={`font-bold text-lg ${analysisReport.colorClass}`}> {analysisReport.title} </h4>
                                    </div>
                                    <p className="text-sm text-slate-700 font-medium leading-relaxed opacity-90 mb-4"> {analysisReport.desc} </p>
                                    <div className="flex flex-wrap gap-2 mt-2"> 
                                        {analysisReport.factors && analysisReport.factors.map((factor, i) => ( 
                                            <div key={i} className={`flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[11px] font-bold border ${factor.isBad ? 'bg-red-50 border-red-100 text-red-700' : 'bg-green-50 border-green-100 text-green-700'}`}>
                                                {factor.isBad ? <TrendingDown size={12}/> : <TrendingUp size={12}/>}
                                                <span>{factor.label}: {factor.val}</span>
                                            </div>
                                        ))} 
                                    </div>
                                </div>
                            </div>
                            
                            {stats.ruinProbLev > 0 && (
                                <div className="bg-red-50 px-5 py-3 border-t border-b border-red-100 flex items-center justify-between animate-pulse">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-red-100 p-1.5 rounded text-red-600"><Skull size={16}/></div>
                                        <div>
                                            <p className="text-sm font-bold text-red-800">åµæ¸¬åˆ°ç ´ç”¢é¢¨éšª (Risk of Ruin)</p>
                                            <p className="text-xs text-red-600 mt-0.5">æœ‰ {stats.ruinProbLev.toFixed(1)}% çš„å¹³è¡Œå®‡å®™ä¸­ï¼Œæ§“æ¡¿æŠ•è³‡è€…è³‡é‡‘å…¨æ•¸è€—ç›¡æ­¸é›¶ã€‚</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setViewMode('survival')} className="px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 shadow-sm transition-colors">
                                        æŸ¥çœ‹ç”Ÿå­˜æ›²ç·š
                                    </button>
                                </div>
                            )}

                            <div className="border-t border-slate-200">
                                <div className="bg-slate-50 px-5 py-3 border-b border-slate-200 flex justify-between items-center">
                                    <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2"> <BarChart2 className="w-4 h-4 text-indigo-600" /> {years} å¹´å¾Œ ç¸½å ±é…¬ç‡èˆ‡é¢¨éšªåˆ†æ (Total Return & Risk) </h4>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs font-bold text-slate-500 uppercase bg-slate-50/50 border-b border-slate-200">
                                            <tr>
                                                <th className="px-5 py-3 whitespace-nowrap">ç­–ç•¥æƒ…å¢ƒ</th>
                                                <th className="px-5 py-3 text-emerald-600 whitespace-nowrap">æ¨‚è§€æƒ…å¢ƒ <br/> <div className="text-[10px] opacity-80 font-normal">(UPSIDE, P90)</div></th>
                                                <th className="px-5 py-3 text-indigo-600 whitespace-nowrap">ä¸­ä½æƒ…å¢ƒ <br/> <div className="text-[10px] opacity-80 font-normal">(MEDIAN, P50)</div></th>
                                                <th className="px-5 py-3 text-red-600 whitespace-nowrap">æ‚²è§€æƒ…å¢ƒ <br/> <div className="text-[10px] opacity-80 font-normal">(DOWNSIDE, P10)</div></th>
                                                <th className="px-5 py-3 text-slate-600 whitespace-nowrap">æ³¢å‹•é¢¨éšª <br/> <div className="text-[10px] opacity-80 font-normal">(STD DEV)</div></th>
                                                <th className="px-5 py-3 text-slate-700 border-l border-slate-100 whitespace-nowrap">ä¸­ä½å¹´åŒ– <br/> <div className="text-[10px] opacity-80 font-normal">(IRR)</div></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            <tr className="bg-orange-50/30 hover:bg-orange-50 transition-colors">
                                                <td className="px-5 py-4 font-medium text-orange-700 flex items-center gap-2.5 text-sm tabular-nums whitespace-nowrap"> <div className="w-2.5 h-2.5 rounded-full bg-orange-500 shadow-sm"></div> æœ‰è²¸æ¬¾ (Leveraged) </td>
                                                <td className="px-5 py-4 font-medium text-emerald-600 text-sm tabular-nums">{formatPercent(stats.levROI.p90)}</td>
                                                <td className="px-5 py-4 font-medium text-indigo-700 text-sm tabular-nums">{formatPercent(stats.levROI.p50)}</td>
                                                <td className="px-5 py-4 font-medium text-red-600 text-sm tabular-nums">{formatPercent(stats.levROI.p10)}</td>
                                                <td className="px-5 py-4 font-medium text-slate-500 text-sm tabular-nums">{stats.levROI.stdDev.toFixed(1)}%</td>
                                                <td className="px-5 py-4 font-medium text-slate-700 border-l border-slate-100 text-sm tabular-nums">{formatPercent(stats.levROI.irrP50)}</td>
                                            </tr>
                                            <tr className="bg-sky-50/10 hover:bg-sky-50/30 transition-colors">
                                                <td className="px-5 py-4 font-medium text-sky-700 flex items-center gap-2.5 text-sm tabular-nums whitespace-nowrap"> <div className="w-2.5 h-2.5 rounded-full bg-sky-500 shadow-sm"></div> ç„¡è²¸æ¬¾ (No Loan) </td>
                                                <td className="px-5 py-4 font-medium text-emerald-600/80 text-sm tabular-nums">{formatPercent(stats.baseROI.p90)}</td>
                                                <td className="px-5 py-4 font-medium text-indigo-700 text-sm tabular-nums">{formatPercent(stats.baseROI.p50)}</td>
                                                <td className="px-5 py-4 font-medium text-red-600/80 text-sm tabular-nums">{formatPercent(stats.baseROI.p10)}</td>
                                                <td className="px-5 py-4 font-medium text-slate-400 text-sm tabular-nums">{stats.baseROI.stdDev.toFixed(1)}%</td>
                                                <td className="px-5 py-4 font-medium text-slate-600 border-l border-slate-100 text-sm tabular-nums">{formatPercent(stats.baseROI.irrP50)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    <div className={`rounded-2xl p-5 border shadow-sm transition-all duration-300 mt-6 ${cashFlowStatus.hasNegativeFlow ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}>
                        <div className="flex items-start gap-4">
                            <div className={`p-2.5 rounded-full border shadow-sm shrink-0 ${cashFlowStatus.hasNegativeFlow ? 'bg-white border-red-100 text-red-600' : 'bg-white border-green-100 text-green-600'}`}>
                                {cashFlowStatus.hasNegativeFlow ? <AlertOctagon className="w-6 h-6" /> : <ShieldCheck className="w-6 h-6" />}
                            </div>
                            <div className="flex-1">
                                <h4 className={`font-bold text-base mb-1 ${cashFlowStatus.hasNegativeFlow ? 'text-red-800' : 'text-green-800'}`}>
                                    {cashFlowStatus.hasNegativeFlow ? 'ç¾é‡‘æµè­¦ç¤ºï¼šéœ€è³£è‚¡é‚„æ¬¾ (Negative Cash Flow)' : 'ç¾é‡‘æµå¥åº·ï¼šå„²è“„å¤§æ–¼é‚„æ¬¾ (Positive Cash Flow)'}
                                </h4>
                                
                                {cashFlowStatus.hasNegativeFlow ? (
                                    <div className="mt-3 space-y-3">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className={`p-3 rounded-lg border ${cashFlowStatus.initialMonthlyDeficit > 0 ? 'bg-red-100 border-red-200' : 'bg-white/50 border-red-100'}`}>
                                                <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1.5">ç•¶å‰/ç«‹å³é¢¨éšª</p>
                                                {cashFlowStatus.initialMonthlyDeficit > 0 ? ( <div> <p className="text-sm text-red-800 font-bold flex items-center gap-1.5"><AlertTriangle size={14}/> ç«‹å³ç™¼ç”Ÿç¼ºå£</p> <p className="text-xs text-red-700 font-medium mt-1">æ¯æœˆéœ€è£œ: {Math.round(cashFlowStatus.initialMonthlyDeficit * 10000).toLocaleString()} å…ƒ</p> </div> ) : ( <p className="text-sm text-green-700 font-bold flex items-center gap-1.5"> <CheckSquare size={14}/> ç›®å‰ç¾é‡‘æµå……è¶³ </p> )}
                                            </div>
                                            <div className="p-3 rounded-lg border bg-amber-50 border-amber-200">
                                                <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1.5">æœªä¾†æœ€å¤§è¡æ“Š</p>
                                                <div className="flex justify-between items-baseline mb-1"> <span className="text-xs font-bold text-amber-900">ç™¼ç”Ÿæ–¼ç¬¬ {cashFlowStatus.maxDeficitYear} å¹´</span> </div>
                                                <p className="text-sm text-amber-800 font-bold"> æœ€å¤§ç¼ºå£: {Math.round(cashFlowStatus.maxMonthlyDeficit * 10000).toLocaleString()} å…ƒ/æœˆ </p>
                                                <div className="mt-2 pt-2 border-t border-amber-200 text-[10px] text-amber-800 font-mono grid grid-cols-2 gap-1"> <span>é‚„æ¬¾: {Math.round(cashFlowStatus.paymentAtMaxDeficit * 10000).toLocaleString()}</span> <span>å„²è“„: {Math.round(cashFlowStatus.savingsAtMaxDeficit * 10000).toLocaleString()}</span> </div>
                                            </div>
                                        </div>
                                        <p className="text-xs text-red-700 font-medium leading-relaxed flex items-start gap-1.5"> <TrendingDown className="w-4 h-4 shrink-0 mt-0.5" /> <span>è§£è®€ï¼šç´…è‰²å€å¡Šé¡¯ç¤ºå³ä½¿è€ƒé‡äº†è–ªè³‡æˆé•·ï¼Œã€Œå«æˆé•·ç‡çš„å„²è“„ã€ä»ä½æ–¼è©²å¹´çš„é‚„æ¬¾é¡ï¼Œå› æ­¤ç”¢ç”Ÿè³‡é‡‘ç¼ºå£ã€‚é€™å°‡è¿«ä½¿æ‚¨åœ¨å¸‚å ´ä¸‹è·Œæ™‚è®Šè³£è³‡ç”¢ï¼Œé€ æˆæ°¸ä¹…æ€§è™§æã€‚</span> </p>
                                    </div>
                                ) : (
                                    <div className="mt-2 text-xs text-green-700 font-medium opacity-90 leading-relaxed">
                                        æ‚¨çš„æ¯æœˆå„²è“„æŠ•å…¥é‡‘é¡é«˜æ–¼è²¸æ¬¾é‚„æ¬¾é¡ï¼Œå³ä½¿åœ¨è²¸æ¬¾å£“åŠ›æœ€å¤§çš„å¹´ä»½ï¼Œä¹Ÿä¸æœƒç™¼ç”Ÿè¢«è¿«è³£è‚¡çš„æƒ…æ³ã€‚é€™æ˜¯æœ€å®‰å…¨çš„æ§“æ¡¿æ“ä½œæ¨¡å¼ã€‚
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mt-6">
                        <h4 className="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <Clock size={16} /> è§¸ç¢° {targetAmount} è¬ ç›®æ¨™æ‰€éœ€æ™‚é–“ (Time to Hit Target)
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-orange-50 rounded-xl p-4 border border-orange-100 relative overflow-hidden">
                                {(100 - stats.timeStats.lev.successRate) > 30 && (
                                    <div className="absolute -right-6 -top-6 w-24 h-24 bg-red-100 rounded-full opacity-50 blur-xl pointer-events-none"></div>
                                )}
                                <div className="flex justify-between items-start mb-3 border-b border-orange-200 pb-2">
                                    <span className="font-bold text-orange-900 text-base">æœ‰è²¸æ¬¾</span>
                                    <div className="flex flex-col items-end">
                                        <span className={`text-xs font-bold px-2 py-1 rounded flex items-center gap-1 ${
                                            (100 - stats.timeStats.lev.successRate) > 20 
                                            ? 'bg-red-100 text-red-700 border border-red-200' 
                                            : 'text-orange-700 bg-orange-200'
                                        }`}>
                                            {(100 - stats.timeStats.lev.successRate) > 20 && <AlertTriangle size={10} />}
                                            æœªé”æ¨™ç‡: {(100 - stats.timeStats.lev.successRate).toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-emerald-700 font-medium flex items-center gap-1">æ¨‚è§€ (P90) <span className="text-[10px] opacity-70">å¸‚å ´å¤§å¥½</span></span>
                                        <span className="font-mono font-bold text-emerald-700 text-lg">{stats.timeStats.lev.p10 ? stats.timeStats.lev.p10.toFixed(1) + ' å¹´' : '-'}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-indigo-700 font-medium flex items-center gap-1">ä¸­ä½ (P50) <span className="text-[10px] opacity-70">å¸‚å ´æ™®é€š</span></span>
                                        <span className="font-mono font-bold text-indigo-700 text-lg">{stats.timeStats.lev.p50 ? stats.timeStats.lev.p50.toFixed(1) + ' å¹´' : '-'}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-red-700 font-medium flex items-center gap-1">æ‚²è§€ (P10) <span className="text-[10px] opacity-70">å¸‚å ´å¤§è·Œ</span></span>
                                        <span className="font-mono font-bold text-red-700 text-lg">{stats.timeStats.lev.p90 ? stats.timeStats.lev.p90.toFixed(1) + ' å¹´' : '-'}</span>
                                    </div>
                                    <div className="pt-2 border-t border-orange-200 flex justify-between items-center">
                                        <span className="text-sm text-orange-800/70 font-medium">å¹³å‡æ™‚é–“</span>
                                        <span className="font-mono font-bold text-orange-900">{stats.timeStats.lev.avg ? stats.timeStats.lev.avg.toFixed(1) + ' å¹´' : '-'}</span>
                                    </div>
                                </div>
                                {(100 - stats.timeStats.lev.successRate) > 0 && (
                                    <div className="mt-3 pt-2 border-t border-orange-200/50">
                                         <p className="text-[10px] text-red-600 font-bold leading-tight flex items-start gap-1">
                                            <AlertOctagon size={12} className="shrink-0 mt-0.5"/>
                                            æ³¨æ„ï¼š{(100 - stats.timeStats.lev.successRate).toFixed(1)}% çš„å¹³è¡Œå®‡å®™åœ¨ {years} å¹´å…§å®Œå…¨ç„¡æ³•é”æˆç›®æ¨™ã€‚å¹³å‡æ™‚é–“åƒ…ä»£è¡¨æˆåŠŸè€…çš„æ•¸æ“šã€‚
                                         </p>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white rounded-xl p-4 border border-slate-200 flex flex-col justify-center items-center text-center">
                                <div className="mb-4">
                                    <span className="text-xs font-bold text-slate-400 uppercase tracking-widest block mb-1 flex items-center gap-1 justify-center">
                                        <Sigma size={12}/> æœŸæœ›ç¯€çœæ™‚é–“ (Integral)
                                    </span>
                                    <div className="text-3xl font-black text-slate-800 tracking-tight">
                                        {stats.timeStats.integralDiff > 0 ? '+' : ''}{stats.timeStats.integralDiff.toFixed(2)}
                                        <span className="text-sm font-bold text-slate-500 ml-1">å¹´</span>
                                    </div>
                                </div>
                                
                                {stats.timeStats.integralDiff > 0 ? (
                                    <div className="inline-flex items-center gap-2 px-3 py-1.5 bg-emerald-100 text-emerald-800 rounded-full font-bold text-sm">
                                        <Timer size={16} /> çµ±è¨ˆæœŸæœ›åŠ é€Ÿ
                                    </div>
                                ) : (
                                    <div className="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-full font-bold text-sm">
                                        <Timer size={16} /> ç„¡åŠ é€Ÿæ•ˆæ‡‰
                                    </div>
                                )}
                                
                                <p className="text-xs text-slate-400 mt-3 px-2 leading-relaxed">
                                    æ­¤æ•¸å€¼ç‚ºã€Œé”æ¨™æ©Ÿç‡æ›²ç·šã€ä¹‹é–“çš„é¢ç©ç©åˆ†ã€‚ä»£è¡¨ç¶œåˆè€ƒé‡æ‰€æœ‰å¸‚å ´å¥½å£æƒ…å¢ƒå¾Œï¼Œæ§“æ¡¿ç­–ç•¥å¹³å‡ç‚ºæ‚¨è²·å›çš„è‡ªç”±æ™‚é–“ã€‚
                                </p>
                            </div>

                            <div className="bg-sky-50 rounded-xl p-4 border border-sky-100 relative overflow-hidden">
                                <div className="flex justify-between items-start mb-3 border-b border-sky-200 pb-2">
                                    <span className="font-bold text-sky-900 text-base">ç„¡è²¸æ¬¾</span>
                                    <span className={`text-xs font-bold px-2 py-1 rounded ${
                                        (100 - stats.timeStats.base.successRate) > 20 
                                        ? 'bg-slate-200 text-slate-700' 
                                        : 'text-sky-700 bg-sky-200'
                                    }`}>
                                        æœªé”æ¨™ç‡: {(100 - stats.timeStats.base.successRate).toFixed(1)}%
                                    </span>
                                </div>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-emerald-700 font-medium">æ¨‚è§€ (P90)</span>
                                        <span className="font-mono font-bold text-emerald-700 text-lg">{stats.timeStats.base.p10 ? stats.timeStats.base.p10.toFixed(1) + ' å¹´' : '-'}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-indigo-700 font-medium">ä¸­ä½ (P50)</span>
                                        <span className="font-mono font-bold text-indigo-700 text-lg">{stats.timeStats.base.p50 ? stats.timeStats.base.p50.toFixed(1) + ' å¹´' : '-'}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-red-700 font-medium">æ‚²è§€ (P10)</span>
                                        <span className="font-mono font-bold text-red-700 text-lg">{stats.timeStats.base.p90 ? stats.timeStats.base.p90.toFixed(1) + ' å¹´' : '-'}</span>
                                    </div>
                                    <div className="pt-2 border-t border-sky-200 flex justify-between items-center">
                                        <span className="text-sm text-sky-800/70 font-medium">å¹³å‡æ™‚é–“</span>
                                        <span className="font-mono font-bold text-sky-900">{stats.timeStats.base.avg ? stats.timeStats.base.avg.toFixed(1) + ' å¹´' : '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-md border border-slate-200 p-6 flex flex-col mt-6">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"> 
                                    {selectedUniverseIndex === -1 ? `è³‡ç”¢æ·¨å€¼æ¨¡æ“¬ (Net Worth)` : `å–®ä¸€å¹³è¡Œå®‡å®™æª¢è¦–`}
                                </h2>
                                
                                {selectedUniverseId === null && viewMode === 'survival' && <p className="text-xs text-red-500 mt-1 font-bold">æª¢è¦–ç­–ç•¥çš„æ­»äº¡é¢¨éšªï¼šæ›²ç·šè¶Šé™¡å³­ï¼Œä»£è¡¨ç ´ç”¢æ­¸é›¶çš„æ©Ÿç‡è¶Šé«˜</p>}
                                {selectedUniverseId === null && viewMode !== 'targetProb' && viewMode !== 'survival' && <p className="text-xs text-slate-400 mt-1 font-medium">éš¨æ©Ÿå‘ˆç¾ 50 æ¢å¸‚å ´è·¯å¾‘ï¼Œå±•ç¤ºçœŸå¯¦çš„æ³¢å‹•é¢¨éšª (æš–è‰²=æœ‰è²¸, å†·è‰²=ç„¡è²¸)</p>}
                                {viewMode === 'targetProb' && <p className="text-xs text-slate-400 mt-1 font-medium">é¡¯ç¤ºæœ‰å¤šå°‘æ¯”ä¾‹çš„å¹³è¡Œå®‡å®™åœ¨ç‰¹å®šæ™‚é–“é»å‰å·²é”æˆ {targetAmount} è¬ç›®æ¨™</p>}

                            </div>
                            <div className="flex items-center gap-2">
                                {selectedUniverseId === null ? (
                                    <div className="bg-slate-100 p-1 rounded-lg flex text-xs font-bold shadow-inner">
                                        <button onClick={() => setViewMode('netWorth')} className={`px-3 py-2 rounded-md flex items-center gap-1.5 transition-all ${viewMode === 'netWorth' ? 'bg-white text-indigo-600 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'}`}> <Eye size={14} /> æ·¨å€¼ </button>
                                        <button onClick={() => setViewMode('leverage')} className={`px-3 py-2 rounded-md flex items-center gap-1.5 transition-all ${viewMode === 'leverage' ? 'bg-white text-emerald-600 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'}`}> <Scale size={14} /> æ§“æ¡¿ </button>
                                        <button onClick={() => setViewMode('targetProb')} className={`px-3 py-2 rounded-md flex items-center gap-1.5 transition-all ${viewMode === 'targetProb' ? 'bg-white text-rose-600 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'}`}> <Target size={14} /> é”æ¨™æ©Ÿç‡ </button>
                                        <button onClick={() => setViewMode('survival')} className={`px-3 py-2 rounded-md flex items-center gap-1.5 transition-all ${viewMode === 'survival' ? 'bg-white text-red-600 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'}`}> <HeartPulse size={14} /> ç”Ÿå­˜ç‡ </button>
                                    </div>
                                ) : (
                                    <button onClick={() => { setSelectedUniverseId(null); setSelectedUniverseIndex(-1); }} className="px-3 py-1.5 rounded-lg flex items-center gap-1.5 bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors text-xs font-bold">
                                        <X size={14} /> è¿”å›ç¸½è¦½
                                    </button>
                                )}
                            </div>
                        </div>

                        <div className={`flex-1 w-full relative min-h-[400px] transition-all duration-300 ${selectedUniverseId !== null && simResults[selectedUniverseId-1]?.isZombie ? 'bg-red-50/50' : ''}`}>
                            {isSimulating ? (
                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-10">
                                    <Loader2 className="w-8 h-8 text-indigo-600 animate-spin mb-2" />
                                    <span className="text-sm font-bold text-slate-500">è’™åœ°å¡ç¾…æ¨¡æ“¬é‹ç®—ä¸­...</span>
                                </div>
                            ) : (
                                <ResponsiveContainer width="100%" height={400}>
                                    <ComposedChart data={displayData} margin={{ top: 20, right: 30, left: 50, bottom: 20 }}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                    <XAxis 
                                        dataKey="year" 
                                        label={{ value: 'å¹´ä»½', position: 'insideBottomRight', offset: -5, fontSize: 11, fill: '#64748b' }} 
                                        stroke="#94a3b8" 
                                        fontSize={12} 
                                        minTickGap={30}
                                        height={30} 
                                        tickLine={false} 
                                        axisLine={false} 
                                    />
                                    <YAxis 
                                        width={85} 
                                        stroke="#94a3b8" 
                                        fontSize={12} 
                                        tickFormatter={(val) => {
                                            if (viewMode === 'targetProb' || viewMode === 'survival') return `${val}%`;
                                            return val > 50 || val < -50 ? val.toLocaleString() : val.toFixed(1) + 'x';
                                        }} 
                                        label={{ value: viewMode === 'netWorth' ? 'æ·¨å€¼ (è¬)' : (viewMode === 'survival' ? 'ç”Ÿå­˜æ©Ÿç‡ (%)' : (viewMode === 'leverage' ? 'æ§“æ¡¿å€æ•¸ (x)' : 'é”æ¨™æ©Ÿç‡ (%)')), angle: -90, position: 'insideLeft', offset: -5, style: { textAnchor: 'middle', fontSize: 11, fill: '#64748b' } }} 
                                        tickLine={false} 
                                        axisLine={false} 
                                        domain={viewMode === 'targetProb' || viewMode === 'survival' ? [0, 100] : ['auto', 'auto']}
                                    />
                                    <Tooltip 
                                        content={ <CustomTooltip /> }
                                        cursor={{ stroke: '#94a3b8', strokeWidth: 1, strokeDasharray: '4 4' }}
                                    />
                                    <Legend 
                                        verticalAlign="top" 
                                        height={40} 
                                        content={<CustomLegend visibleSeries={visibleSeries} onToggle={toggleSeries} />}
                                        payload={(viewMode === 'targetProb' || viewMode === 'survival') ? [
                                            { value: viewMode === 'survival' ? 'ç”Ÿå­˜ç‡ (æœ‰è²¸æ¬¾)' : 'é”æ¨™æ©Ÿç‡ (æœ‰è²¸æ¬¾)', type: 'line', color: viewMode === 'survival' ? "#dc2626" : "#ea580c", id: 'probLev' }, 
                                            { value: viewMode === 'survival' ? 'ç”Ÿå­˜ç‡ (ç„¡è²¸æ¬¾)' : 'é”æ¨™æ©Ÿç‡ (ç„¡è²¸æ¬¾)', type: 'line', color: "#0ea5e9", id: 'probBase' }, 
                                        ] : (selectedUniverseId !== null ? [
                                            { value: 'è©²å®‡å®™-æœ‰è²¸æ¬¾', type: 'line', color: "#ea580c", id: 'leveraged' }, 
                                            { value: 'è©²å®‡å®™-ç„¡è²¸æ¬¾', type: 'line', color: "#0ea5e9", id: 'noLoan' }, 
                                        ] : [ 
                                            { value: 'æœ‰è²¸æ¬¾ (P50)', type: 'line', color: "#ea580c", id: 'leveraged' }, 
                                            { value: 'ç„¡è²¸æ¬¾ (P50)', type: 'line', color: "#0ea5e9", id: 'noLoan' }, 
                                        ])} 
                                    />
                                    
                                    {viewMode === 'netWorth' && ( <ReferenceLine y={0} stroke="#ef4444" strokeDasharray="5 5" strokeWidth={2} /> )}
                                    {viewMode === 'leverage' && ( <ReferenceLine y={1} stroke="#0ea5e9" strokeDasharray="3 3" label={{ value: 'ç„¡æ§“æ¡¿ (1.0x)', fill: '#0ea5e9', fontSize: 10 }} /> )}
                                    {viewMode === 'targetProb' && ( <ReferenceLine y={50} stroke="#94a3b8" strokeDasharray="3 3" label={{ value: '50% æ©Ÿç‡ç·š', fill: '#94a3b8', fontSize: 10 }} /> )}
                                    {viewMode === 'survival' && ( <ReferenceLine y={100} stroke="#94a3b8" strokeDasharray="3 3" /> )}

                                    {/* Ruin Indicator: Show ReferenceDot if focusing on a dead universe */}
                                    {selectedUniverseId !== null && simResults[selectedUniverseId-1]?.isZombie && simResults[selectedUniverseId-1]?.bustYear && viewMode === 'netWorth' && (
                                        <ReferenceDot 
                                            x={simResults[selectedUniverseId-1].bustYear} 
                                            y={0} 
                                            r={6} 
                                            fill="#dc2626" 
                                            stroke="white" 
                                            strokeWidth={2}
                                        >
                                            <Label value="ğŸ’€ ASSETS WIPED OUT" position="top" fill="#dc2626" fontSize={12} fontWeight="bold" />
                                        </ReferenceDot>
                                    )}

                                    {selectedUniverseId === null && (viewMode === 'netWorth' || viewMode === 'leverage') && (
                                        <>
                                            {visibleSeries.leveraged && Array.from({ length: 50 }).map((_, i) => ( <Line key={`lev_bg_${i}`} type="monotone" dataKey={`lev_bg_${i}`} stroke="#f97316" strokeWidth={1} dot={false} strokeOpacity={0.12} isAnimationActive={false} /> ))}
                                            {visibleSeries.noLoan && Array.from({ length: 50 }).map((_, i) => ( <Line key={`base_bg_${i}`} type="monotone" dataKey={`base_bg_${i}`} stroke="#0ea5e9" strokeWidth={1} dot={false} strokeOpacity={0.12} isAnimationActive={false} /> ))}

                                            {visibleSeries.leveraged && <Line type="monotone" dataKey="p50Lev" stroke="#ea580c" strokeWidth={3} dot={false} name="p50Lev" activeDot={{ r: 6, strokeWidth: 0 }} />}
                                            {visibleSeries.noLoan && <Line type="monotone" dataKey="p50Base" stroke="#0284c7" strokeWidth={3} dot={false} name="p50Base" activeDot={{ r: 6, strokeWidth: 0 }} />}
                                        </>
                                    )}

                                    {selectedUniverseId !== null && (viewMode === 'netWorth' || viewMode === 'leverage') && (
                                        <>
                                            {visibleSeries.leveraged && <Line type="monotone" dataKey="focusLev" stroke={simResults[selectedUniverseId-1]?.isZombie ? "#dc2626" : "#ea580c"} strokeWidth={3} dot={false} name="focusLev" animationDuration={500} />}
                                            {visibleSeries.noLoan && <Line type="monotone" dataKey="focusBase" stroke="#0ea5e9" strokeWidth={3} dot={false} name="focusBase" animationDuration={500} />}
                                        </>
                                    )}

                                    {(viewMode === 'targetProb' || viewMode === 'survival') && (
                                        <>
                                            <Area type="monotone" dataKey="p50Lev" stroke={viewMode === 'survival' ? "#dc2626" : "#ea580c"} fill={viewMode === 'survival' ? "#dc2626" : "#ea580c"} fillOpacity={0.1} strokeWidth={3} name={viewMode === 'survival' ? "survivalLev" : "probLev"} />
                                            <Area type="monotone" dataKey="p50Base" stroke="#0ea5e9" fill="#0ea5e9" fillOpacity={0.1} strokeWidth={3} name={viewMode === 'survival' ? "survivalBase" : "probBase"} />
                                        </>
                                    )}
                                    
                                    {viewMode === 'netWorth' && <Line type="monotone" dataKey="principal" stroke="#f59e0b" strokeWidth={2} strokeDasharray="5 5" dot={false} name="principal" />}

                                    </ComposedChart>
                                </ResponsiveContainer>
                            )}
                        </div>
                        
                        {viewMode !== 'targetProb' && viewMode !== 'survival' && (
                            <div className="mt-4 px-4 pt-6 border-t border-slate-100">
                                <div className="relative h-6 w-full mb-2">
                                    <div 
                                        className="absolute bottom-0 flex flex-col items-center -translate-x-1/2 transition-all duration-500"
                                        style={{ left: `${((stats.breakevenRank - 1) / (simulationCount - 1)) * 100}%` }}
                                    >
                                        <div className="text-[10px] font-bold text-slate-500 whitespace-nowrap mb-1">
                                            {stats.breakevenRank === 1 ? "" : (stats.breakevenRank > simulationCount ? "ç„¡å‹ç®—" : "å‹è² åˆ†ç•Œ")}
                                        </div>
                                        <div className="w-0.5 h-3 bg-slate-400/50"></div>
                                    </div>
                                </div>

                                <div className="relative h-6 w-full flex items-center">
                                    <div className="absolute top-1/2 -translate-y-1/2 left-0 right-0 h-2 rounded-full overflow-hidden flex">
                                        <div className="h-full bg-red-100" style={{ width: `${((stats.breakevenRank - 1) / (simulationCount - 1)) * 100}%` }}></div>
                                        <div className="h-full bg-emerald-100" style={{ width: `${100 - ((stats.breakevenRank - 1) / (simulationCount - 1)) * 100}%` }}></div>
                                    </div>

                                    <input 
                                        type="range" 
                                        min="1" 
                                        max={simulationCount} 
                                        step="1"
                                        value={sliderValue === 0 ? Math.floor(simulationCount/2) : sliderValue}
                                        onChange={(e) => handleSliderChange(Number(e.target.value))}
                                        className="absolute w-full h-2 opacity-0 cursor-pointer z-10" 
                                    />
                                    
                                    <div 
                                        className={`absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white border-2 rounded-full shadow pointer-events-none transition-all duration-75 ${selectedUniverseIndex === -1 ? 'border-slate-300 opacity-50' : 'border-slate-600 opacity-100'}`}
                                        style={{ left: `calc(${(((sliderValue === 0 ? Math.floor(simulationCount/2) : sliderValue) - 1) / (simulationCount - 1)) * 100}% - 8px)` }} 
                                    ></div>
                                </div>

                                <div className="flex justify-between items-center mt-2">
                                    <span className="text-xs font-bold text-red-400 uppercase tracking-wider flex items-center gap-1">
                                        <TrendingDown size={12}/> æœ€å·® (Worst)
                                    </span>
                                    <span className="text-xs font-bold text-slate-700 flex items-center gap-2 bg-slate-50 px-3 py-1 rounded-full border border-slate-200">
                                        {selectedUniverseIndex === -1 ? "æ‹–å‹•æ»‘æ¡¿ä»¥æª¢è¦–ç‰¹å®šæƒ…å¢ƒ" : "ç•¶å‰æ’å (Rank)"}
                                        <div className="relative flex items-center">
                                            <Hash className="absolute left-2 w-3 h-3 text-slate-400" />
                                            <input type="number" min="1" max={simulationCount} value={sliderValue === 0 ? '' : sliderValue} placeholder="-" onChange={(e) => { const val = Number(e.target.value); if(val >= 1 && val <= simulationCount) handleSliderChange(val); }} className="w-16 pl-6 pr-1 py-0.5 text-center border-none bg-transparent text-xs font-mono font-bold focus:ring-0 outline-none" />
                                            <span className="text-[10px] text-slate-400 ml-1">/ {simulationCount}</span>
                                        </div>
                                    </span>
                                    <span className="text-xs font-bold text-emerald-400 uppercase tracking-wider flex items-center gap-1">
                                        æœ€å¥½ (Best) <TrendingUp size={12}/>
                                    </span>
                                </div>
                            </div>
                        )}

                    </div>
                    
                    <div className="mt-8 bg-slate-50 rounded-xl border border-slate-200 p-6 overflow-hidden">
                        <div className="flex items-center justify-between mb-4 cursor-pointer" onClick={() => setShowAudit(!showAudit)}>
                            <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2"> 
                                <Search className="w-4 h-4 text-slate-500" /> 
                                æ¨¡æ“¬è·¯å¾‘è©³ç´°ç¨½æ ¸ (Simulation Audit Trail)
                            </h4>
                            <span className="text-xs text-indigo-600 font-bold hover:underline">{showAudit ? "éš±è—ç´°ç¯€" : "å±•é–‹æŸ¥çœ‹ 20 æ¢ç¯„ä¾‹"}</span>
                        </div>
                        
                        {showAudit && (
                            <div className="overflow-x-auto border-t border-slate-200 pt-4 animate-in slide-in-from-top-2 duration-300">
                                <p className="text-xs text-slate-500 mb-3">
                                    éš¨æ©ŸæŠ½é¸ 20 æ¢å¹³è¡Œå®‡å®™ã€‚
                                    <span className="ml-2 bg-amber-50 text-amber-700 px-2 py-0.5 rounded border border-amber-200">
                                        æ³¨æ„ï¼šæ·¨å€¼è² æ•¸ä»£è¡¨ã€Œæ°´ä¸‹éƒ¨ä½ã€ï¼Œæ­¸é›¶æ‰ä»£è¡¨ã€Œå¯¦è³ªç ´ç”¢ã€
                                    </span>
                                </p>
                                <table className="w-full text-xs text-left">
                                    <thead className="text-slate-500 font-bold bg-slate-100/50 uppercase border-b border-slate-200">
                                        <tr>
                                            <th className="px-3 py-2">å®‡å®™ ID</th>
                                            <th className="px-3 py-2 text-orange-700">æœ‰è²¸ç¸½å ±é…¬</th>
                                            <th className="px-3 py-2 text-orange-700 border-r border-slate-200">æœ‰è²¸æœŸæœ«æ·¨å€¼</th>
                                            
                                            <th className="px-3 py-2 text-sky-700 pl-4">ç„¡è²¸ç¸½å ±é…¬</th>
                                            <th className="px-3 py-2 text-sky-700">ç„¡è²¸æœŸæœ«æ·¨å€¼</th>

                                            <th className="px-3 py-2 text-right text-slate-600 border-l border-slate-200">ç´¯ç©è‡ªæœ‰æŠ•å…¥</th>
                                            <th className="px-3 py-2 text-right text-slate-400">ç´¯ç©åˆ©æ¯æˆæœ¬</th>
                                            <th className="px-3 py-2 text-center border-l border-slate-200">å‹è² åˆ¤å®š</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 bg-white">
                                        {[...auditData].sort((a,b) => a.id - b.id).map((row) => (
                                            <tr 
                                                key={row.id} 
                                                onClick={() => handleRowClick(row.id)} 
                                                className={`
                                                    cursor-pointer transition-all duration-200
                                                    ${selectedUniverseId === row.id ? 'bg-indigo-50 ring-1 ring-indigo-200 shadow-inner' : 'hover:bg-slate-50'}
                                                `}
                                            >
                                                <td className="px-3 py-2 font-mono text-slate-400">#{row.id}</td>
                                                <td className="px-3 py-2 font-mono tabular-nums text-orange-700 font-bold">
                                                    {row.isZombie ? <span className="flex items-center gap-1 text-red-600 line-through decoration-red-600/50"><Skull size={12}/> {formatPercent(row.levROI)}</span> : formatPercent(row.levROI)}
                                                </td>
                                                <td className="px-3 py-2 font-mono tabular-nums text-orange-600 border-r border-slate-100">
                                                    {Math.round(row.finalLevNet).toLocaleString()}
                                                </td>
                                                <td className="px-3 py-2 font-mono tabular-nums text-sky-700 font-bold pl-4">{formatPercent(row.baseROI)}</td>
                                                <td className="px-3 py-2 font-mono tabular-nums text-sky-600">
                                                    {Math.round(row.finalBaseNet).toLocaleString()}
                                                </td>
                                                <td className="px-3 py-2 font-mono tabular-nums text-right text-slate-600 border-l border-slate-100">
                                                    {Math.round(stats.totalInvested).toLocaleString()}
                                                </td>
                                                <td className="px-3 py-2 font-mono tabular-nums text-right text-slate-400">
                                                    -{new Intl.NumberFormat('zh-TW', { notation: "compact" }).format(row.totalInterest)}
                                                </td>
                                                <td className="px-3 py-2 text-center flex items-center justify-center gap-1 border-l border-slate-100">
                                                    {row.isZombie && <span className="px-2 py-0.5 rounded bg-red-100 text-red-700 font-bold text-[10px]">ğŸ’¸ å·²çˆ†å€‰</span>}
                                                    {!row.isZombie && row.winner === 'lev' && <span className="px-2 py-0.5 rounded bg-orange-100 text-orange-700 font-bold">æœ‰è²¸å‹</span>}
                                                    {!row.isZombie && row.winner === 'base' && <span className="px-2 py-0.5 rounded bg-sky-100 text-sky-700 font-bold">ç„¡è²¸å‹</span>}
                                                    {!row.isZombie && row.winner === 'tie' && <span className="px-2 py-0.5 rounded bg-slate-100 text-slate-500">å¹³æ‰‹</span>}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    <div className="bg-amber-50/50 border border-amber-100 rounded-xl p-4 mt-6">
                        <div className="flex items-start gap-3">
                        <div className="p-2 bg-amber-100 rounded-full shrink-0"> <BookOpen className="w-5 h-5 text-amber-700" /> </div>
                        <div>
                            <h4 className="text-sm font-bold text-amber-900 mb-2">æ¨¡å‹é™åˆ¶èˆ‡æ ¡æ­£æé†’ (Model Disclaimers)</h4>
                            <ul className="text-xs text-amber-800 space-y-1.5 list-disc list-inside opacity-90">
                                <li><strong>v2.17 é¢¨éšªè¨»é‡‹å„ªåŒ– (Risk Clarification)</strong>ï¼šæ˜ç¢ºæ¨™ç¤ºã€Œåˆ°æœŸå…¨é‚„ã€åŠŸèƒ½ä»£è¡¨ç„¡æ³•çºŒç´„çš„æƒ…å¢ƒï¼Œå¹«åŠ©æŠ•è³‡äººç†è§£æµå‹•æ€§é¢¨éšªçš„ä¾†æºã€‚</li>
                                <li><strong>æ··åˆæƒ…å¢ƒ</strong>ï¼šæ”¯æ´åŒæ™‚æ¨¡æ“¬ã€Œæˆ¿è²¸ï¼ˆä¸æ–·é ­ï¼‰ã€ã€ã€Œèè³‡ï¼ˆæœƒæ–·é ­ï¼‰ã€èˆ‡ã€Œåˆ°æœŸä¸€æ¬¡é‚„æœ¬ã€çš„è¤‡é›œå‚µå‹™çµ„åˆã€‚</li>
                                <li><strong>æµå‹•æ€§æ˜¯å”¯ä¸€æ­»ç©´ (Liquidity is King)</strong>ï¼šå°æ–¼æœªå•Ÿç”¨ç¶­æŒç‡é™åˆ¶çš„è²¸æ¬¾ï¼ˆå¦‚æˆ¿è²¸ï¼‰ï¼Œå”¯ä¸€æœƒå°è‡´ç ´ç”¢çš„åŸå› æ˜¯ã€Œç¹³ä¸å‡ºè²¸æ¬¾ã€ã€‚è«‹å‹™å¿…é—œæ³¨å·¦å´çš„ã€Œç¾é‡‘æµè­¦ç¤ºã€å„€è¡¨æ¿ã€‚</li>
                                <li><strong>è² è³‡ç”¢å¿ƒç†å£“åŠ›</strong>ï¼šé›–ç„¶æˆ¿è²¸æ¨¡å¼å…è¨±æ·¨å€¼ç‚ºè² ï¼ˆæ°´ä¸‹ï¼‰ï¼Œä½†ç¾å¯¦ä¸­çœ‹è‘—è³‡ç”¢è² å‚µè¡¨èµ¤å­—éœ€è¦æ¥µå¼·çš„å¿ƒç†ç´ è³ªï¼Œè«‹å‹¿å¿½è¦–å¿ƒç†å¸³æˆ¶çš„å½±éŸ¿ã€‚</li>
                            </ul>
                        </div>
                        </div>
                    </div>
                    </div>
                </div>
                
                <div className="mt-10 mb-6 text-center">
                    <a 
                        href="https://www.facebook.com/search/top?q=æŒ‡æ•¸ä¸‰å¯¶é£¯" 
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-1.5 text-[11px] text-slate-300 hover:text-slate-500 transition-colors select-none group"
                    >
                        <span>Designed by</span>
                        <span className="font-bold underline decoration-slate-200 underline-offset-2 group-hover:decoration-slate-400">fb/æŒ‡æ•¸ä¸‰å¯¶é£¯</span>
                        <ExternalLink size={10} className="opacity-60 group-hover:opacity-100" />
                    </a>
                </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
